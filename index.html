<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Policy Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initialize Supabase client
        // IMPORTANT: Replace these with your actual Supabase URL and anon key
        const SUPABASE_URL = 'https://owqylzpuxwsldepufxep.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_IWFsW7Fp1xUzKkr82yVavw_wu236ZdP'; // Get this from Supabase dashboard
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function DCPolicyTracker() {
            const [items, setItems] = useState([]);
            const [filters, setFilters] = useState({
                keywords: '',
                committee: 'all',
                category: 'all',
                assignedTo: 'all',
                priority: 'all',
                actionStatus: 'all',
                introducedBy: 'all',
                hideTrackedItems: false
            });
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [itemNotes, setItemNotes] = useState({});
            const [trackedKeywords, setTrackedKeywords] = useState([]);
            const [trackedCommittees, setTrackedCommittees] = useState([]);
            const [trackedSponsors, setTrackedSponsors] = useState([]);
            const [searchMode, setSearchMode] = useState('all'); // 'all', 'keywords', 'committees', 'sponsors'
            const [teamMembers, setTeamMembers] = useState([]);
            const [councilPeriods, setCouncilPeriods] = useState([]);
            const [selectedPeriod, setSelectedPeriod] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showAddKeyword, setShowAddKeyword] = useState(false);
            const [showAddCommittee, setShowAddCommittee] = useState(false);
            const [showAddSponsor, setShowAddSponsor] = useState(false);
            const [newKeyword, setNewKeyword] = useState('');
            const [newCommittee, setNewCommittee] = useState('');
            const [newSponsor, setNewSponsor] = useState('');
            const [editingNote, setEditingNote] = useState(null);
            const [noteText, setNoteText] = useState('');
            const [showManualEntry, setShowManualEntry] = useState(false);
            const [editingManualEntry, setEditingManualEntry] = useState(null);
            const [showActivityLog, setShowActivityLog] = useState(false);
            const [showEmailPreview, setShowEmailPreview] = useState(false);
            const [showTeamManagement, setShowTeamManagement] = useState(false);
            const [editingTeamMember, setEditingTeamMember] = useState(null);
            const [teamMemberForm, setTeamMemberForm] = useState({ name: '', email: '' });
            const [activityLog, setActivityLog] = useState([]);
            const [manualEntry, setManualEntry] = useState({
                title: '',
                agency: '',
                status: 'Published',
                date: new Date().toISOString().split('T')[0],
                link: '',
                assignedTo: 'Unassigned',
                priority: 'medium',
                actionStatus: 'action_needed',
                noticeId: '',
                registerIssue: '',
                registerNotes: ''
            });

            const PROXY_URL = 'https://dcpca-policy-tracker.vercel.app/api/hello';

            useEffect(() => {
                loadFromSupabase();
                loadCouncilPeriods();
            }, []);

            // Load all data from Supabase
            const loadFromSupabase = async () => {
                try {
                    // Load tracked items
                    const { data: trackedData, error: trackedError } = await supabase
                        .from('tracked_items')
                        .select('*')
                        .order('tracked_at', { ascending: false });
                    
                    if (trackedError) throw trackedError;
                    
                    if (trackedData) {
                        const itemsSet = new Set(trackedData.map(item => item.id));
                        setSelectedItems(itemsSet);
                        
                        // Convert tracked items to display format and SET THEM AS ITEMS immediately
                        const displayItems = trackedData.map(item => ({
                            id: item.id,
                            title: item.title,
                            billNumber: item.bill_number,
                            category: item.category,
                            status: item.status,
                            committees: item.committees || [],
                            date: item.date,
                            description: item.description,
                            link: item.link,
                            source: item.source,
                            agency: item.agency,
                            isNew: item.is_new,
                            assignedTo: item.assigned_to,
                            priority: item.priority,
                            actionStatus: item.action_status || 'action_needed',
                            introducedBy: item.introduced_by,
                            hasNewActivity: item.has_new_activity || false,
                            activitySummary: item.activity_summary || null,
                            lastStatus: item.last_status || null,
                            lastCheckedAt: item.last_checked_at,
                            noticeId: item.notice_id || null,
                            registerIssue: item.register_issue || null,
                            registerNotes: item.register_notes || null,
                            isManualEntry: item.is_manual_entry || false
                        }));
                        
                        // IMMEDIATELY show tracked items (this is the key change!)
                        setItems(displayItems);
                    }

                    // Load notes
                    const { data: notesData, error: notesError } = await supabase
                        .from('item_notes')
                        .select('*');
                    
                    if (notesError) throw notesError;
                    
                    if (notesData) {
                        const notesMap = {};
                        notesData.forEach(note => {
                            notesMap[note.item_id] = note.note_text;
                        });
                        setItemNotes(notesMap);
                    }

                    // Load keywords
                    const { data: keywordsData, error: keywordsError } = await supabase
                        .from('tracked_keywords')
                        .select('*')
                        .order('added_at', { ascending: true });
                    
                    if (keywordsError) throw keywordsError;
                    
                    if (keywordsData) {
                        setTrackedKeywords(keywordsData.map(k => k.keyword));
                    }

                    // Load committees
                    const { data: committeesData, error: committeesError } = await supabase
                        .from('tracked_committees')
                        .select('*')
                        .order('added_at', { ascending: true });
                    
                    if (committeesError) throw committeesError;
                    
                    if (committeesData) {
                        setTrackedCommittees(committeesData.map(c => c.committee_name));
                    }

                    // Load sponsors
                    const { data: sponsorsData, error: sponsorsError } = await supabase
                        .from('tracked_sponsors')
                        .select('*')
                        .order('added_at', { ascending: true });
                    
                    if (sponsorsError) throw sponsorsError;
                    
                    if (sponsorsData) {
                        setTrackedSponsors(sponsorsData.map(s => s.sponsor_name));
                    }

                    // Load team members
                    const { data: membersData, error: membersError } = await supabase
                        .from('team_members')
                        .select('*')
                        .eq('active', true)
                        .order('name', { ascending: true });
                    
                    if (membersError) throw membersError;
                    
                    if (membersData) {
                        setTeamMembers(membersData);
                    }

                } catch (err) {
                    console.error('Error loading from Supabase:', err);
                    setError('Failed to load data: ' + err.message);
                }
            };

            // Log activity to database
            const logActivity = async (action, itemId, itemTitle, details = {}) => {
                try {
                    const { error } = await supabase
                        .from('activity_log')
                        .insert({
                            action,
                            item_id: itemId,
                            item_title: itemTitle,
                            details
                        });
                    
                    if (error) console.error('Error logging activity:', error);
                } catch (err) {
                    console.error('Error logging activity:', err);
                }
            };

            // Load activity log
            const loadActivityLog = async () => {
                try {
                    const { data, error } = await supabase
                        .from('activity_log')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(100);
                    
                    if (error) throw error;
                    setActivityLog(data || []);
                } catch (err) {
                    console.error('Error loading activity log:', err);
                }
            };

            const proxyFetch = async (endpoint, method = 'GET', body = null) => {
                try {
                    const params = new URLSearchParams({ endpoint, method });
                    if (body) params.append('body', JSON.stringify(body));
                    
                    const url = `${PROXY_URL}?${params.toString()}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    return data;
                } catch (error) {
                    console.error('Proxy fetch error:', error);
                    throw error;
                }
            };

            const loadCouncilPeriods = async () => {
                try {
                    setLoading(true);
                    const data = await proxyFetch('/CouncilPeriods');
                    setCouncilPeriods(data);
                    if (data.length > 0) {
                        setSelectedPeriod(data[0]);
                    }
                    setLoading(false);
                } catch (err) {
                    setError('Failed to load council periods: ' + err.message);
                    setLoading(false);
                }
            };

            const refreshData = async () => {
                if (!selectedPeriod) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    let allPromises = [];
                    
                    // Search by keywords (only if search mode allows)
                    if ((searchMode === 'all' || searchMode === 'keywords') && trackedKeywords.length > 0) {
                        const keywordPromises = trackedKeywords.map(keyword =>
                            proxyFetch('/SearchLegislation', 'POST', {
                                Keyword: keyword,
                                CategoryId: 0,
                                CouncilPeriodId: selectedPeriod.councilPeriodId,
                                RowLimit: 20,
                                OffSet: 0
                            }).catch(err => {
                                console.error(`Error searching for "${keyword}":`, err);
                                return [];
                            })
                        );
                        allPromises.push(...keywordPromises);
                    }

                    // Search by committees (only if search mode allows)
                    if ((searchMode === 'all' || searchMode === 'committees') && trackedCommittees.length > 0) {
                        const committeePromises = trackedCommittees.map(async committee => {
                            try {
                                const results = await proxyFetch('/SearchLegislation', 'POST', {
                                    Keyword: committee,
                                    CategoryId: 0,
                                    CouncilPeriodId: selectedPeriod.councilPeriodId,
                                    RowLimit: 50, // Get more results to filter through
                                    OffSet: 0
                                });
                                
                                // Filter to only include items where the committee actually matches
                                const filtered = Array.isArray(results) ? results.filter(leg => {
                                    const committeeStr = leg.referredToCommittees;
                                    if (!committeeStr || committeeStr === 'null') return false;
                                    // Check if the committee name is in the referredToCommittees field
                                    return committeeStr.toLowerCase().includes(committee.toLowerCase());
                                }) : [];
                                
                                return filtered;
                            } catch (err) {
                                console.error(`Error searching for committee "${committee}":`, err);
                                return [];
                            }
                        });
                        allPromises.push(...committeePromises);
                    }

                    // Search by sponsors (only if search mode allows)
                    // Use BulkData endpoint which includes full legislation details including sponsors
                    if ((searchMode === 'all' || searchMode === 'sponsors') && trackedSponsors.length > 0) {
                        const sponsorPromises = trackedSponsors.map(async sponsor => {
                            try {
                                console.log(`Fetching bulk data to find bills by "${sponsor}"...`);
                                
                                // Use BulkData endpoint - POST with categoryId and councilPeriodId in path
                                const endpoint = `/BulkData/${0}/${selectedPeriod.councilPeriodId}`;
                                const bulkData = await proxyFetch(endpoint, 'POST', null);
                                
                                console.log(`BulkData returned ${bulkData?.length || 0} bills`);
                                
                                // Log sample to see structure
                                if (bulkData && bulkData.length > 0) {
                                    console.log('BulkData sample bill:', {
                                        legislationNumber: bulkData[0].legislationNumber,
                                        introducedBy: bulkData[0].introducedBy,
                                        introducers: bulkData[0].introducers,
                                        primarySponsor: bulkData[0].primarySponsor,
                                        introducersType: typeof bulkData[0].introducers
                                    });
                                }
                                
                                // Filter by sponsor fields
                                const filtered = Array.isArray(bulkData) ? bulkData.filter(leg => {
                                    // Check all possible sponsor fields
                                    const introducedBy = leg.introducedBy || '';
                                    const primarySponsor = leg.primarySponsor || '';
                                    const coIntroducers = leg.coIntroducers || '';
                                    const sponsor_field = leg.sponsor || '';
                                    
                                    // Handle introducers - might be array or string
                                    let introducers = '';
                                    if (Array.isArray(leg.introducers)) {
                                        introducers = leg.introducers.join(' ');
                                    } else if (typeof leg.introducers === 'object' && leg.introducers !== null) {
                                        introducers = JSON.stringify(leg.introducers);
                                    } else {
                                        introducers = leg.introducers || '';
                                    }
                                    
                                    // Combine only sponsor-related fields
                                    const sponsorText = `${introducedBy} ${primarySponsor} ${coIntroducers} ${introducers} ${sponsor_field}`.toLowerCase();
                                    
                                    const matches = sponsorText.includes(sponsor.toLowerCase());
                                    
                                    if (matches) {
                                        console.log(`✓ Sponsor match for "${sponsor}":`, {
                                            billNumber: leg.legislationNumber,
                                            title: leg.title,
                                            introducedBy,
                                            introducers: leg.introducers
                                        });
                                    }
                                    
                                    return matches;
                                }) : [];
                                
                                console.log(`Found ${filtered.length} bills introduced by "${sponsor}"`);
                                return filtered;
                            } catch (err) {
                                console.error(`Error searching for sponsor "${sponsor}":`, err);
                                console.warn('⚠️ BulkData endpoint failed. Sponsor search is currently unavailable.');
                                console.warn('For accurate sponsor searches, please use: https://lims.dccouncil.gov/voteSearch');
                                return [];
                            }
                        });
                        allPromises.push(...sponsorPromises);
                    }

                    const results = await Promise.all(allPromises);
                    
                    const allLegislation = [];
                    const seenIds = new Set();
                    
                    results.forEach(result => {
                        const legislation = Array.isArray(result) ? result : [];
                        
                        legislation.forEach(leg => {
                            if (leg && leg.legislationNumber && !seenIds.has(leg.legislationNumber)) {
                                seenIds.add(leg.legislationNumber);
                                allLegislation.push(leg);
                            }
                        });
                    });

                    const transformedItems = allLegislation.map(leg => {
                        const committeeStr = leg.referredToCommittees;
                        let committees = [];
                        
                        if (committeeStr && committeeStr !== 'null' && typeof committeeStr === 'string' && committeeStr.trim()) {
                            committees = [committeeStr];
                        }
                        
                        // Get introduced by information - check multiple possible fields
                        const introducedBy = leg.introducedBy || leg.primarySponsor || leg.introducers || leg.sponsor || null;
                        
                        // Log what we found for debugging
                        if (introducedBy) {
                            console.log('Found sponsor info:', {
                                billNumber: leg.legislationNumber,
                                introducedBy: leg.introducedBy,
                                primarySponsor: leg.primarySponsor,
                                introducers: leg.introducers,
                                sponsor: leg.sponsor,
                                selected: introducedBy
                            });
                        }
                        
                        return {
                            id: leg.legislationNumber,
                            title: leg.title,
                            billNumber: leg.legislationNumber,
                            category: leg.category || leg.subCategory || 'Uncategorized',
                            status: leg.status || 'Unknown',
                            committees: committees,
                            date: leg.introductionDate ? new Date(leg.introductionDate).toISOString().split('T')[0] : '',
                            description: leg.shortDescription || leg.title,
                            link: `https://lims.dccouncil.gov/Legislation/${leg.legislationNumber}`,
                            source: 'DC Council',
                            isNew: isNewItem(leg.introductionDate),
                            assignedTo: null,
                            priority: null,
                            actionStatus: 'action_needed',
                            introducedBy: introducedBy
                        };
                    });

                    // Merge with existing tracked items (to preserve assignments, priorities, and action statuses)
                    // AND keep any tracked items that weren't in the API results
                    const existingTrackedItems = items.filter(item => 
                        selectedItems.has(item.id) && 
                        !allLegislation.some(leg => leg.legislationNumber === item.id)
                    );
                    
                    const mergedItems = transformedItems.map(item => {
                        if (selectedItems.has(item.id)) {
                            const existing = items.find(i => i.id === item.id);
                            if (existing) {
                                // Detect activity changes
                                let hasNewActivity = false;
                                let activitySummary = null;
                                
                                // Check if status changed
                                if (existing.lastStatus && existing.status !== item.status) {
                                    hasNewActivity = true;
                                    activitySummary = `Status changed from "${existing.lastStatus}" to "${item.status}"`;
                                }
                                
                                // Update the item in database with new activity info
                                if (hasNewActivity) {
                                    updateItemActivity(item.id, item.status, activitySummary);
                                }
                                
                                return {
                                    ...item,
                                    assignedTo: existing.assignedTo,
                                    priority: existing.priority,
                                    actionStatus: existing.actionStatus,
                                    hasNewActivity: hasNewActivity,
                                    activitySummary: activitySummary,
                                    lastStatus: item.status,
                                    lastCheckedAt: new Date().toISOString()
                                };
                            }
                        }
                        return item;
                    });

                    // Combine: existing tracked items that weren't in API + new API results
                    setItems([...existingTrackedItems, ...mergedItems]);
                    setLoading(false);
                } catch (err) {
                    console.error('Error in refreshData:', err);
                    setError('Failed to fetch legislation: ' + err.message);
                    setLoading(false);
                }
            };

            const isNewItem = (dateString) => {
                if (!dateString) return false;
                const itemDate = new Date(dateString);
                const daysSince = (new Date() - itemDate) / (1000 * 60 * 60 * 24);
                return daysSince <= 7;
            };

            const toggleSelection = async (itemId) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;

                const isCurrentlySelected = selectedItems.has(itemId);
                
                try {
                    if (isCurrentlySelected) {
                        // Untrack item - delete from database
                        const { error } = await supabase
                            .from('tracked_items')
                            .delete()
                            .eq('id', itemId);
                        
                        if (error) throw error;
                        
                        const newSelected = new Set(selectedItems);
                        newSelected.delete(itemId);
                        setSelectedItems(newSelected);
                        
                        await logActivity('item_untracked', itemId, item.title);
                    } else {
                        // Track item - insert into database
                        const { error } = await supabase
                            .from('tracked_items')
                            .insert({
                                id: item.id,
                                title: item.title,
                                bill_number: item.billNumber,
                                category: item.category,
                                status: item.status,
                                committees: item.committees,
                                date: item.date,
                                description: item.description,
                                link: item.link,
                                source: item.source,
                                agency: item.agency,
                                is_manual_entry: item.source === 'Municipal Register',
                                is_new: item.isNew,
                                assigned_to: 'Unassigned',
                                priority: 'medium',
                                action_status: 'action_needed',
                                introduced_by: item.introducedBy,
                                last_status: item.status,
                                last_checked_at: new Date().toISOString(),
                                has_new_activity: false
                            });
                        
                        if (error) throw error;
                        
                        const newSelected = new Set(selectedItems);
                        newSelected.add(itemId);
                        setSelectedItems(newSelected);
                        
                        // Update the item with default values
                        setItems(items.map(i => 
                            i.id === itemId 
                                ? { ...i, assignedTo: 'Unassigned', priority: 'medium', actionStatus: 'action_needed' }
                                : i
                        ));
                        
                        await logActivity('item_tracked', itemId, item.title, {
                            source: item.source,
                            category: item.category
                        });
                    }
                } catch (err) {
                    console.error('Error toggling selection:', err);
                    setError('Failed to update tracking: ' + err.message);
                }
            };

            const updateAssignment = async (itemId, newAssignee) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;

                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .update({ assigned_to: newAssignee })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    setItems(items.map(i => 
                        i.id === itemId ? { ...i, assignedTo: newAssignee } : i
                    ));
                    
                    await logActivity('assigned', itemId, item.title, {
                        from: item.assignedTo,
                        to: newAssignee
                    });
                } catch (err) {
                    console.error('Error updating assignment:', err);
                    setError('Failed to update assignment: ' + err.message);
                }
            };

            const updatePriority = async (itemId, newPriority) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;

                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .update({ priority: newPriority })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    setItems(items.map(i => 
                        i.id === itemId ? { ...i, priority: newPriority } : i
                    ));
                    
                    await logActivity('priority_changed', itemId, item.title, {
                        from: item.priority,
                        to: newPriority
                    });
                } catch (err) {
                    console.error('Error updating priority:', err);
                    setError('Failed to update priority: ' + err.message);
                }
            };

            const updateActionStatus = async (itemId, newStatus) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;

                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .update({ action_status: newStatus })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    setItems(items.map(i => 
                        i.id === itemId ? { ...i, actionStatus: newStatus } : i
                    ));
                    
                    await logActivity('action_status_changed', itemId, item.title, {
                        from: item.actionStatus,
                        to: newStatus
                    });
                } catch (err) {
                    console.error('Error updating action status:', err);
                    setError('Failed to update action status: ' + err.message);
                }
            };

            const updateItemActivity = async (itemId, newStatus, activitySummary) => {
                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .update({
                            last_status: newStatus,
                            has_new_activity: true,
                            activity_summary: activitySummary,
                            last_checked_at: new Date().toISOString()
                        })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    await logActivity('activity_detected', itemId, null, {
                        summary: activitySummary
                    });
                } catch (err) {
                    console.error('Error updating item activity:', err);
                }
            };

            const markActivityAsSeen = async (itemId) => {
                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .update({
                            has_new_activity: false,
                            activity_summary: null
                        })
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    setItems(items.map(i => 
                        i.id === itemId ? { ...i, hasNewActivity: false, activitySummary: null } : i
                    ));
                } catch (err) {
                    console.error('Error marking activity as seen:', err);
                    setError('Failed to mark activity as seen: ' + err.message);
                }
            };

            const saveNote = async () => {
                if (!editingNote) return;
                
                const item = items.find(i => i.id === editingNote);
                
                try {
                    const { error } = await supabase
                        .from('item_notes')
                        .upsert({
                            item_id: editingNote,
                            note_text: noteText
                        });
                    
                    if (error) throw error;
                    
                    setItemNotes({...itemNotes, [editingNote]: noteText});
                    
                    await logActivity(
                        itemNotes[editingNote] ? 'note_updated' : 'note_added',
                        editingNote,
                        item?.title || 'Unknown'
                    );
                    
                    setEditingNote(null);
                    setNoteText('');
                } catch (err) {
                    console.error('Error saving note:', err);
                    setError('Failed to save note: ' + err.message);
                }
            };

            const deleteNote = async (itemId) => {
                const item = items.find(i => i.id === itemId);
                
                try {
                    const { error } = await supabase
                        .from('item_notes')
                        .delete()
                        .eq('item_id', itemId);
                    
                    if (error) throw error;
                    
                    const newNotes = {...itemNotes};
                    delete newNotes[itemId];
                    setItemNotes(newNotes);
                    
                    await logActivity('note_deleted', itemId, item?.title || 'Unknown');
                } catch (err) {
                    console.error('Error deleting note:', err);
                    setError('Failed to delete note: ' + err.message);
                }
            };

            const addKeyword = async () => {
                if (!newKeyword.trim() || trackedKeywords.includes(newKeyword.toLowerCase())) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from('tracked_keywords')
                        .insert({ keyword: newKeyword.toLowerCase() });
                    
                    if (error) throw error;
                    
                    setTrackedKeywords([...trackedKeywords, newKeyword.toLowerCase()]);
                    setNewKeyword('');
                    setShowAddKeyword(false);
                    
                    await logActivity('keyword_added', null, null, { keyword: newKeyword.toLowerCase() });
                } catch (err) {
                    console.error('Error adding keyword:', err);
                    setError('Failed to add keyword: ' + err.message);
                }
            };

            const removeKeyword = async (keyword) => {
                try {
                    const { error } = await supabase
                        .from('tracked_keywords')
                        .delete()
                        .eq('keyword', keyword);
                    
                    if (error) throw error;
                    
                    setTrackedKeywords(trackedKeywords.filter(k => k !== keyword));
                    
                    await logActivity('keyword_removed', null, null, { keyword });
                } catch (err) {
                    console.error('Error removing keyword:', err);
                    setError('Failed to remove keyword: ' + err.message);
                }
            };

            const addCommittee = async () => {
                if (!newCommittee.trim() || trackedCommittees.includes(newCommittee)) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from('tracked_committees')
                        .insert({ committee_name: newCommittee });
                    
                    if (error) throw error;
                    
                    setTrackedCommittees([...trackedCommittees, newCommittee]);
                    setNewCommittee('');
                    setShowAddCommittee(false);
                    
                    await logActivity('committee_added', null, null, { committee: newCommittee });
                } catch (err) {
                    console.error('Error adding committee:', err);
                    setError('Failed to add committee: ' + err.message);
                }
            };

            const removeCommittee = async (committee) => {
                try {
                    const { error } = await supabase
                        .from('tracked_committees')
                        .delete()
                        .eq('committee_name', committee);
                    
                    if (error) throw error;
                    
                    setTrackedCommittees(trackedCommittees.filter(c => c !== committee));
                    
                    await logActivity('committee_removed', null, null, { committee });
                } catch (err) {
                    console.error('Error removing committee:', err);
                    setError('Failed to remove committee: ' + err.message);
                }
            };

            const addSponsor = async () => {
                if (!newSponsor.trim() || trackedSponsors.includes(newSponsor)) {
                    return;
                }
                
                try {
                    const { error } = await supabase
                        .from('tracked_sponsors')
                        .insert({ sponsor_name: newSponsor });
                    
                    if (error) throw error;
                    
                    setTrackedSponsors([...trackedSponsors, newSponsor]);
                    setNewSponsor('');
                    setShowAddSponsor(false);
                    
                    await logActivity('sponsor_added', null, null, { sponsor: newSponsor });
                } catch (err) {
                    console.error('Error adding sponsor:', err);
                    setError('Failed to add sponsor: ' + err.message);
                }
            };

            const removeSponsor = async (sponsor) => {
                try {
                    const { error } = await supabase
                        .from('tracked_sponsors')
                        .delete()
                        .eq('sponsor_name', sponsor);
                    
                    if (error) throw error;
                    
                    setTrackedSponsors(trackedSponsors.filter(s => s !== sponsor));
                    
                    await logActivity('sponsor_removed', null, null, { sponsor });
                } catch (err) {
                    console.error('Error removing sponsor:', err);
                    setError('Failed to remove sponsor: ' + err.message);
                }
            };

            const addManualEntry = async () => {
                if (!manualEntry.title.trim()) {
                    alert('Please enter a title');
                    return;
                }

                const newItem = {
                    id: `MANUAL-${Date.now()}`,
                    title: manualEntry.title,
                    billNumber: null,
                    agency: manualEntry.agency || 'DC Government',
                    category: 'Municipal Regulation',
                    status: manualEntry.status,
                    date: manualEntry.date,
                    description: manualEntry.title,
                    link: manualEntry.link,
                    source: 'Municipal Register',
                    isNew: isNewItem(manualEntry.date),
                    committees: [],
                    assignedTo: manualEntry.assignedTo,
                    priority: manualEntry.priority,
                    actionStatus: manualEntry.actionStatus,
                    introducedBy: null,
                    noticeId: manualEntry.noticeId,
                    registerIssue: manualEntry.registerIssue,
                    registerNotes: manualEntry.registerNotes,
                    isManualEntry: true
                };

                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .insert({
                            id: newItem.id,
                            title: newItem.title,
                            bill_number: null,
                            category: newItem.category,
                            status: newItem.status,
                            committees: [],
                            date: newItem.date,
                            description: newItem.description,
                            link: newItem.link,
                            source: newItem.source,
                            agency: newItem.agency,
                            is_manual_entry: true,
                            is_new: newItem.isNew,
                            assigned_to: newItem.assignedTo,
                            priority: newItem.priority,
                            action_status: newItem.actionStatus,
                            introduced_by: null,
                            notice_id: newItem.noticeId,
                            register_issue: newItem.registerIssue,
                            register_notes: newItem.registerNotes
                        });
                    
                    if (error) throw error;
                    
                    setItems([newItem, ...items]);
                    const newSelected = new Set(selectedItems);
                    newSelected.add(newItem.id);
                    setSelectedItems(newSelected);
                    
                    await logActivity('manual_entry_added', newItem.id, newItem.title, {
                        source: 'Municipal Register'
                    });
                    
                    setShowManualEntry(false);
                    setManualEntry({
                        title: '',
                        agency: '',
                        status: 'Published',
                        date: new Date().toISOString().split('T')[0],
                        link: '',
                        assignedTo: 'Unassigned',
                        priority: 'medium',
                        actionStatus: 'action_needed',
                        noticeId: '',
                        registerIssue: '',
                        registerNotes: ''
                    });
                } catch (err) {
                    console.error('Error adding manual entry:', err);
                    setError('Failed to add manual entry: ' + err.message);
                }
            };

            const editManualEntry = (item) => {
                setEditingManualEntry(item.id);
                setManualEntry({
                    title: item.title,
                    agency: item.agency || '',
                    status: item.status,
                    date: item.date,
                    link: item.link || '',
                    assignedTo: item.assignedTo,
                    priority: item.priority,
                    actionStatus: item.actionStatus,
                    noticeId: item.noticeId || '',
                    registerIssue: item.registerIssue || '',
                    registerNotes: item.registerNotes || ''
                });
                setShowManualEntry(true);
            };

            const updateManualEntry = async () => {
                if (!manualEntry.title.trim()) {
                    alert('Please enter a title');
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .update({
                            title: manualEntry.title,
                            agency: manualEntry.agency,
                            status: manualEntry.status,
                            date: manualEntry.date,
                            link: manualEntry.link,
                            assigned_to: manualEntry.assignedTo,
                            priority: manualEntry.priority,
                            action_status: manualEntry.actionStatus,
                            notice_id: manualEntry.noticeId,
                            register_issue: manualEntry.registerIssue,
                            register_notes: manualEntry.registerNotes,
                            description: manualEntry.title
                        })
                        .eq('id', editingManualEntry);
                    
                    if (error) throw error;
                    
                    // Update in local state
                    setItems(items.map(item => 
                        item.id === editingManualEntry
                            ? {
                                ...item,
                                title: manualEntry.title,
                                agency: manualEntry.agency,
                                status: manualEntry.status,
                                date: manualEntry.date,
                                link: manualEntry.link,
                                assignedTo: manualEntry.assignedTo,
                                priority: manualEntry.priority,
                                actionStatus: manualEntry.actionStatus,
                                noticeId: manualEntry.noticeId,
                                registerIssue: manualEntry.registerIssue,
                                registerNotes: manualEntry.registerNotes,
                                description: manualEntry.title
                            }
                            : item
                    ));
                    
                    await logActivity('manual_entry_updated', editingManualEntry, manualEntry.title);
                    
                    setShowManualEntry(false);
                    setEditingManualEntry(null);
                    setManualEntry({
                        title: '',
                        agency: '',
                        status: 'Published',
                        date: new Date().toISOString().split('T')[0],
                        link: '',
                        assignedTo: 'Unassigned',
                        priority: 'medium',
                        actionStatus: 'action_needed',
                        noticeId: '',
                        registerIssue: '',
                        registerNotes: ''
                    });
                } catch (err) {
                    console.error('Error updating manual entry:', err);
                    setError('Failed to update manual entry: ' + err.message);
                }
            };

            const deleteManualEntry = async (itemId) => {
                if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('tracked_items')
                        .delete()
                        .eq('id', itemId);
                    
                    if (error) throw error;
                    
                    // Remove from local state
                    setItems(items.filter(item => item.id !== itemId));
                    const newSelected = new Set(selectedItems);
                    newSelected.delete(itemId);
                    setSelectedItems(newSelected);
                    
                    await logActivity('manual_entry_deleted', itemId, null);
                } catch (err) {
                    console.error('Error deleting manual entry:', err);
                    setError('Failed to delete manual entry: ' + err.message);
                }
            };

            const addTeamMember = async () => {
                if (!teamMemberForm.name.trim()) {
                    alert('Please enter a name');
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('team_members')
                        .insert({
                            name: teamMemberForm.name,
                            email: teamMemberForm.email || null,
                            active: true
                        });
                    
                    if (error) throw error;
                    
                    // Reload team members
                    const { data: membersData } = await supabase
                        .from('team_members')
                        .select('*')
                        .eq('active', true)
                        .order('name', { ascending: true });
                    
                    if (membersData) {
                        setTeamMembers(membersData);
                    }
                    
                    setTeamMemberForm({ name: '', email: '' });
                    await logActivity('team_member_added', null, null, { name: teamMemberForm.name });
                } catch (err) {
                    console.error('Error adding team member:', err);
                    setError('Failed to add team member: ' + err.message);
                }
            };

            const editTeamMember = (member) => {
                setEditingTeamMember(member.id);
                setTeamMemberForm({ name: member.name, email: member.email || '' });
            };

            const updateTeamMember = async () => {
                if (!teamMemberForm.name.trim()) {
                    alert('Please enter a name');
                    return;
                }

                try {
                    const oldMember = teamMembers.find(m => m.id === editingTeamMember);
                    
                    const { error } = await supabase
                        .from('team_members')
                        .update({
                            name: teamMemberForm.name,
                            email: teamMemberForm.email || null
                        })
                        .eq('id', editingTeamMember);
                    
                    if (error) throw error;
                    
                    // Update assignments if name changed
                    if (oldMember && oldMember.name !== teamMemberForm.name) {
                        const { error: updateError } = await supabase
                            .from('tracked_items')
                            .update({ assigned_to: teamMemberForm.name })
                            .eq('assigned_to', oldMember.name);
                        
                        if (updateError) console.error('Error updating assignments:', updateError);
                        
                        // Update local items
                        setItems(items.map(item => 
                            item.assignedTo === oldMember.name 
                                ? { ...item, assignedTo: teamMemberForm.name }
                                : item
                        ));
                    }
                    
                    // Reload team members
                    const { data: membersData } = await supabase
                        .from('team_members')
                        .select('*')
                        .eq('active', true)
                        .order('name', { ascending: true });
                    
                    if (membersData) {
                        setTeamMembers(membersData);
                    }
                    
                    setEditingTeamMember(null);
                    setTeamMemberForm({ name: '', email: '' });
                    
                    await logActivity('team_member_updated', null, null, { 
                        from: oldMember?.name, 
                        to: teamMemberForm.name 
                    });
                } catch (err) {
                    console.error('Error updating team member:', err);
                    setError('Failed to update team member: ' + err.message);
                }
            };

            const deleteTeamMember = async (memberId) => {
                const member = teamMembers.find(m => m.id === memberId);
                
                if (!confirm(`Are you sure you want to delete ${member?.name}? All assignments to this person will remain but won't be in the dropdown.`)) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('team_members')
                        .update({ active: false })
                        .eq('id', memberId);
                    
                    if (error) throw error;
                    
                    // Reload team members
                    const { data: membersData } = await supabase
                        .from('team_members')
                        .select('*')
                        .eq('active', true)
                        .order('name', { ascending: true });
                    
                    if (membersData) {
                        setTeamMembers(membersData);
                    }
                    
                    await logActivity('team_member_deleted', null, null, { name: member?.name });
                } catch (err) {
                    console.error('Error deleting team member:', err);
                    setError('Failed to delete team member: ' + err.message);
                }
            };

            const generateEmailBody = () => {
                const reportItems = filteredItems.filter(item => 
                    selectedItems.has(item.id) && 
                    (item.actionStatus === 'action_needed' || item.actionStatus === 'monitor_and_assess')
                );

                const actionNeeded = reportItems.filter(item => item.actionStatus === 'action_needed');
                const monitorAndAssess = reportItems.filter(item => item.actionStatus === 'monitor_and_assess');

                let emailBody = `DC Policy Tracker - Status Update\n`;
                emailBody += `Generated: ${new Date().toLocaleDateString()}\n\n`;
                emailBody += `=================================================\n\n`;

                if (actionNeeded.length > 0) {
                    emailBody += `ACTION NEEDED (${actionNeeded.length} items)\n`;
                    emailBody += `=================================================\n\n`;
                    actionNeeded.forEach((item, idx) => {
                        emailBody += `${idx + 1}. ${item.title}\n`;
                        emailBody += `   Bill Number: ${item.billNumber || 'N/A'}\n`;
                        emailBody += `   Category: ${item.category}\n`;
                        emailBody += `   Status: ${item.status}\n`;
                        emailBody += `   Assigned To: ${item.assignedTo || 'Unassigned'}\n`;
                        emailBody += `   Priority: ${item.priority || 'N/A'}\n`;
                        if (item.introducedBy) emailBody += `   Introduced By: ${item.introducedBy}\n`;
                        if (itemNotes[item.id]) emailBody += `   Notes: ${itemNotes[item.id]}\n`;
                        emailBody += `   Link: ${item.link}\n`;
                        emailBody += `\n`;
                    });
                }

                if (monitorAndAssess.length > 0) {
                    emailBody += `\nMONITOR AND ASSESS (${monitorAndAssess.length} items)\n`;
                    emailBody += `=================================================\n\n`;
                    monitorAndAssess.forEach((item, idx) => {
                        emailBody += `${idx + 1}. ${item.title}\n`;
                        emailBody += `   Bill Number: ${item.billNumber || 'N/A'}\n`;
                        emailBody += `   Category: ${item.category}\n`;
                        emailBody += `   Status: ${item.status}\n`;
                        emailBody += `   Assigned To: ${item.assignedTo || 'Unassigned'}\n`;
                        emailBody += `   Priority: ${item.priority || 'N/A'}\n`;
                        if (item.introducedBy) emailBody += `   Introduced By: ${item.introducedBy}\n`;
                        if (itemNotes[item.id]) emailBody += `   Notes: ${itemNotes[item.id]}\n`;
                        emailBody += `   Link: ${item.link}\n`;
                        emailBody += `\n`;
                    });
                }

                if (reportItems.length === 0) {
                    emailBody += `No items with "Action Needed" or "Monitor and Assess" status.\n`;
                }

                return emailBody;
            };

            const copyEmailToClipboard = () => {
                const emailBody = generateEmailBody();
                navigator.clipboard.writeText(emailBody).then(() => {
                    alert('Email content copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy to clipboard');
                });
            };

            const exportToCSV = () => {
                const itemsToExport = filteredItems;

                const headers = ['Title', 'Bill Number', 'Category', 'Status', 'Committees', 'Date', 'Assigned To', 'Priority', 'Action Status', 'Introduced By', 'Link', 'Notes', 'Tracked'];
                const rows = itemsToExport.map(item => [
                    item.title,
                    item.billNumber || '',
                    item.category,
                    item.status,
                    item.committees ? item.committees.join('; ') : '',
                    item.date,
                    item.assignedTo || '',
                    item.priority || '',
                    item.actionStatus || '',
                    item.introducedBy || '',
                    item.link || '',
                    itemNotes[item.id] || '',
                    selectedItems.has(item.id) ? 'Yes' : 'No'
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dc-policy-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            const filteredItems = items.filter(item => {
                const matchesKeyword = !filters.keywords || 
                    item.title.toLowerCase().includes(filters.keywords.toLowerCase()) ||
                    item.description.toLowerCase().includes(filters.keywords.toLowerCase());
                const matchesCommittee = filters.committee === 'all' || 
                    (item.committees && item.committees.some(c => c === filters.committee));
                const matchesCategory = filters.category === 'all' || item.category === filters.category;
                const matchesAssignedTo = filters.assignedTo === 'all' || item.assignedTo === filters.assignedTo;
                const matchesPriority = filters.priority === 'all' || item.priority === filters.priority;
                
                // Action status filter: only show tracked items when filtering by action status
                const matchesActionStatus = filters.actionStatus === 'all' || 
                    (selectedItems.has(item.id) && item.actionStatus === filters.actionStatus);
                
                const matchesIntroducedBy = filters.introducedBy === 'all' || item.introducedBy === filters.introducedBy;
                
                // Hide tracked items filter
                const matchesHideTracked = !filters.hideTrackedItems || !selectedItems.has(item.id);
                
                return matchesKeyword && matchesCommittee && matchesCategory && matchesAssignedTo && matchesPriority && matchesActionStatus && matchesIntroducedBy && matchesHideTracked;
            });

            const categories = ['all', ...new Set(items.map(i => i.category).filter(Boolean))];
            const committees = ['all', ...new Set(items.filter(i => i.committees && i.committees.length > 0).flatMap(i => i.committees).filter(Boolean))];
            const assignees = ['all', ...new Set(items.map(i => i.assignedTo).filter(Boolean))];
            const priorities = ['all', 'high', 'medium', 'low'];
            const actionStatuses = ['all', 'action_needed', 'action_completed', 'monitor_and_assess'];
            const introducers = ['all', ...new Set(items.map(i => i.introducedBy).filter(Boolean))];

            const getPriorityColor = (priority) => {
                switch(priority) {
                    case 'high': return 'bg-red-100 text-red-700';
                    case 'medium': return 'bg-yellow-100 text-yellow-700';
                    case 'low': return 'bg-green-100 text-green-700';
                    default: return 'bg-gray-100 text-gray-700';
                }
            };

            const getActionStatusColor = (status) => {
                switch(status) {
                    case 'action_needed': return 'bg-red-100 text-red-700';
                    case 'action_completed': return 'bg-green-100 text-green-700';
                    case 'monitor_and_assess': return 'bg-blue-100 text-blue-700';
                    default: return 'bg-gray-100 text-gray-700';
                }
            };

            const getActionStatusLabel = (status) => {
                switch(status) {
                    case 'action_needed': return 'ACTION NEEDED';
                    case 'action_completed': return 'ACTION COMPLETED';
                    case 'monitor_and_assess': return 'MONITOR & ASSESS';
                    default: return status;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">DC Policy Tracker</h1>
                                    <p className="text-gray-600">Legislative Monitoring System</p>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    <button
                                        onClick={() => setShowTeamManagement(true)}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                    >
                                        👥 Manage Team
                                    </button>
                                    <button
                                        onClick={() => setShowEmailPreview(true)}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        📧 Generate Email
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowActivityLog(true);
                                            loadActivityLog();
                                        }}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                    >
                                        📋 Activity Log
                                    </button>
                                    <button
                                        onClick={() => setShowManualEntry(true)}
                                        className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                    >
                                        + Add DC Register
                                    </button>
                                    <button
                                        onClick={exportToCSV}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        Export CSV
                                    </button>
                                    <button
                                        onClick={refreshData}
                                        disabled={loading}
                                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400"
                                    >
                                        {loading ? 'Loading...' : 'Refresh'}
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4 flex justify-between items-center">
                                    <span>{error}</span>
                                    <button onClick={() => setError(null)} className="text-red-700 hover:text-red-900">×</button>
                                </div>
                            )}

                            {selectedPeriod && (
                                <div className="text-sm text-gray-600 flex items-center justify-between">
                                    <div>
                                        Council Period: <strong>{selectedPeriod.councilPeriod}</strong>
                                        {selectedItems.size > 0 && <span className="ml-2 px-2 py-1 bg-indigo-100 text-indigo-700 rounded">{selectedItems.size} items tracked</span>}
                                        {items.filter(i => i.hasNewActivity && selectedItems.has(i.id)).length > 0 && (
                                            <span className="ml-2 px-2 py-1 bg-orange-500 text-white rounded animate-pulse">
                                                🔔 {items.filter(i => i.hasNewActivity && selectedItems.has(i.id)).length} with new activity
                                            </span>
                                        )}
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setFilters({...filters, actionStatus: 'action_needed'})}
                                            className="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200"
                                        >
                                            Show Action Needed
                                        </button>
                                        <button
                                            onClick={() => setFilters({...filters, actionStatus: 'monitor_and_assess'})}
                                            className="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                        >
                                            Show Monitor & Assess
                                        </button>
                                        <button
                                            onClick={() => setFilters({...filters, actionStatus: 'action_completed'})}
                                            className="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200"
                                        >
                                            Show Completed
                                        </button>
                                        <button
                                            onClick={() => setFilters({...filters, actionStatus: 'all'})}
                                            className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                                        >
                                            Show All
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">Search Mode</h2>
                                    <div className="space-y-2">
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="searchMode"
                                                value="all"
                                                checked={searchMode === 'all'}
                                                onChange={(e) => setSearchMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span className="text-sm">Search All (Keywords + Committees + Sponsors)</span>
                                        </label>
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="searchMode"
                                                value="keywords"
                                                checked={searchMode === 'keywords'}
                                                onChange={(e) => setSearchMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span className="text-sm">Keywords Only</span>
                                        </label>
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="searchMode"
                                                value="committees"
                                                checked={searchMode === 'committees'}
                                                onChange={(e) => setSearchMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span className="text-sm">Committees Only</span>
                                        </label>
                                        <label className="flex items-center">
                                            <input
                                                type="radio"
                                                name="searchMode"
                                                value="sponsors"
                                                checked={searchMode === 'sponsors'}
                                                onChange={(e) => setSearchMode(e.target.value)}
                                                className="mr-2"
                                            />
                                            <span className="text-sm">Sponsors Only</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Keywords</h2>
                                        <button
                                            onClick={() => setShowAddKeyword(true)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        {trackedKeywords.map(keyword => (
                                            <div key={keyword} className="flex items-center justify-between p-2 bg-indigo-50 rounded">
                                                <span className="capitalize">{keyword}</span>
                                                <button
                                                    onClick={() => removeKeyword(keyword)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Committees</h2>
                                        <button
                                            onClick={() => setShowAddCommittee(true)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        {trackedCommittees.map(committee => (
                                            <div key={committee} className="flex items-center justify-between p-2 bg-blue-50 rounded">
                                                <span className="text-sm">{committee}</span>
                                                <button
                                                    onClick={() => removeCommittee(committee)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Sponsors</h2>
                                        <button
                                            onClick={() => setShowAddSponsor(true)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        {trackedSponsors.map(sponsor => (
                                            <div key={sponsor} className="flex items-center justify-between p-2 bg-purple-50 rounded">
                                                <span className="text-sm">{sponsor}</span>
                                                <button
                                                    onClick={() => removeSponsor(sponsor)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">Filters</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Search</label>
                                            <input
                                                type="text"
                                                value={filters.keywords}
                                                onChange={(e) => setFilters({...filters, keywords: e.target.value})}
                                                placeholder="Search..."
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Category</label>
                                            <select
                                                value={filters.category}
                                                onChange={(e) => setFilters({...filters, category: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {categories.map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Committee</label>
                                            <select
                                                value={filters.committee}
                                                onChange={(e) => setFilters({...filters, committee: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {committees.map(com => (
                                                    <option key={com} value={com}>{com}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Introduced By</label>
                                            <select
                                                value={filters.introducedBy}
                                                onChange={(e) => setFilters({...filters, introducedBy: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {introducers.map(intro => (
                                                    <option key={intro} value={intro}>{intro}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Assigned To</label>
                                            <select
                                                value={filters.assignedTo}
                                                onChange={(e) => setFilters({...filters, assignedTo: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {assignees.map(assignee => (
                                                    <option key={assignee} value={assignee}>{assignee}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Priority</label>
                                            <select
                                                value={filters.priority}
                                                onChange={(e) => setFilters({...filters, priority: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {priorities.map(priority => (
                                                    <option key={priority} value={priority}>{priority}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Action Status</label>
                                            <select
                                                value={filters.actionStatus}
                                                onChange={(e) => setFilters({...filters, actionStatus: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {actionStatuses.map(status => (
                                                    <option key={status} value={status}>
                                                        {status === 'all' ? 'all' : getActionStatusLabel(status)}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="pt-4 border-t">
                                            <label className="flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={filters.hideTrackedItems}
                                                    onChange={(e) => setFilters({...filters, hideTrackedItems: e.target.checked})}
                                                    className="mr-2"
                                                />
                                                <span className="text-sm font-medium">Hide all tracked items</span>
                                            </label>
                                            <p className="text-xs text-gray-500 mt-1 ml-6">
                                                Hide items marked as Action Needed, Monitor & Assess, or Action Completed
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">
                                        Legislation ({filteredItems.length})
                                    </h2>

                                    {loading && (
                                        <div className="text-center py-12 text-gray-500">
                                            Loading legislation...
                                        </div>
                                    )}

                                    {!loading && filteredItems.length === 0 && (
                                        <div className="text-center py-12 text-gray-500">
                                            {items.length === 0 ? 'No tracked items yet. Click Refresh to search for legislation.' : 'No items match your filters'}
                                        </div>
                                    )}

                                    <div className="space-y-4">
                                        {filteredItems.map(item => (
                                            <div
                                                key={item.id}
                                                className={`p-4 border-2 rounded-lg ${
                                                    item.isNew ? 'border-red-200 bg-red-50' : 'border-gray-200'
                                                } ${selectedItems.has(item.id) ? 'ring-2 ring-indigo-400' : ''}`}
                                            >
                                                <div className="flex items-start gap-3">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedItems.has(item.id)}
                                                        onChange={() => toggleSelection(item.id)}
                                                        className="mt-1"
                                                    />
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                            {item.isNew && (
                                                                <span className="px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded">
                                                                    NEW
                                                                </span>
                                                            )}
                                                            {item.hasNewActivity && selectedItems.has(item.id) && (
                                                                <span className="px-2 py-0.5 bg-orange-500 text-white text-xs font-bold rounded animate-pulse">
                                                                    🔔 NEW ACTIVITY
                                                                </span>
                                                            )}
                                                            {selectedItems.has(item.id) && (
                                                                <span className={`px-2 py-0.5 text-xs font-bold rounded ${getActionStatusColor(item.actionStatus)}`}>
                                                                    {getActionStatusLabel(item.actionStatus)}
                                                                </span>
                                                            )}
                                                            {item.priority && (
                                                                <span className={`px-2 py-0.5 text-xs font-bold rounded uppercase ${getPriorityColor(item.priority)}`}>
                                                                    {item.priority}
                                                                </span>
                                                            )}
                                                            <h3 className="font-semibold">{item.title}</h3>
                                                        </div>
                                                        
                                                        {item.hasNewActivity && item.activitySummary && selectedItems.has(item.id) && (
                                                            <div className="mb-2 p-2 bg-orange-50 border-l-4 border-orange-500 rounded">
                                                                <div className="flex justify-between items-start">
                                                                    <div>
                                                                        <div className="text-xs font-semibold text-orange-800 mb-1">Activity Update:</div>
                                                                        <p className="text-sm text-orange-700">{item.activitySummary}</p>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => markActivityAsSeen(item.id)}
                                                                        className="text-xs text-orange-600 hover:text-orange-800 underline ml-2"
                                                                    >
                                                                        Dismiss
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        <div className="text-xs text-gray-500 mb-2">
                                                            <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">
                                                                {item.billNumber || item.id}
                                                            </a>
                                                            {item.introducedBy && (
                                                                <span className="ml-2">• Introduced by: {item.introducedBy}</span>
                                                            )}
                                                        </div>
                                                        <p className="text-sm text-gray-600 mb-2">{item.description}</p>

                                                        {item.committees && item.committees.length > 0 && (
                                                            <div className="mb-2">
                                                                <div className="text-xs font-semibold mb-1">Committees:</div>
                                                                <div className="flex flex-wrap gap-1">
                                                                    {item.committees.map((com, idx) => (
                                                                        <span key={`${item.id}-${idx}`} className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">
                                                                            {com}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {item.isManualEntry && (item.noticeId || item.registerIssue || item.registerNotes) && (
                                                            <div className="mb-2 p-2 bg-purple-50 border border-purple-200 rounded">
                                                                {item.noticeId && (
                                                                    <div className="text-xs mb-1">
                                                                        <span className="font-semibold">Notice ID:</span> {item.noticeId}
                                                                    </div>
                                                                )}
                                                                {item.registerIssue && (
                                                                    <div className="text-xs mb-1">
                                                                        <span className="font-semibold">Register Issue:</span> {item.registerIssue}
                                                                    </div>
                                                                )}
                                                                {item.registerNotes && (
                                                                    <div className="text-xs">
                                                                        <span className="font-semibold">Register Notes:</span>
                                                                        <p className="mt-1 whitespace-pre-wrap">{item.registerNotes}</p>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}

                                                        {selectedItems.has(item.id) && (
                                                            <div className="grid grid-cols-3 gap-2 mb-2">
                                                                <div>
                                                                    <label className="block text-xs font-semibold mb-1">Assigned To:</label>
                                                                    <select
                                                                        value={item.assignedTo || 'Unassigned'}
                                                                        onChange={(e) => updateAssignment(item.id, e.target.value)}
                                                                        className="w-full px-2 py-1 text-xs border rounded"
                                                                    >
                                                                        {teamMembers.map(member => (
                                                                            <option key={member.id} value={member.name}>
                                                                                {member.name}
                                                                            </option>
                                                                        ))}
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold mb-1">Priority:</label>
                                                                    <select
                                                                        value={item.priority || 'medium'}
                                                                        onChange={(e) => updatePriority(item.id, e.target.value)}
                                                                        className="w-full px-2 py-1 text-xs border rounded"
                                                                    >
                                                                        <option value="high">High</option>
                                                                        <option value="medium">Medium</option>
                                                                        <option value="low">Low</option>
                                                                    </select>
                                                                </div>
                                                                <div>
                                                                    <label className="block text-xs font-semibold mb-1">Action Status:</label>
                                                                    <select
                                                                        value={item.actionStatus || 'action_needed'}
                                                                        onChange={(e) => updateActionStatus(item.id, e.target.value)}
                                                                        className="w-full px-2 py-1 text-xs border rounded"
                                                                    >
                                                                        <option value="action_needed">Action Needed</option>
                                                                        <option value="action_completed">Action Completed</option>
                                                                        <option value="monitor_and_assess">Monitor & Assess</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        )}

                                                        {itemNotes[item.id] && (
                                                            <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                                                <div className="flex justify-between">
                                                                    <div>
                                                                        <div className="text-xs font-semibold text-yellow-800 mb-1">Note:</div>
                                                                        <p className="text-sm">{itemNotes[item.id]}</p>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => deleteNote(item.id)}
                                                                        className="text-red-600 hover:text-red-800"
                                                                    >
                                                                        ×
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        )}

                                                        <div className="flex items-center justify-between mt-2">
                                                            <div className="flex items-center gap-2 text-xs text-gray-500 flex-wrap">
                                                                <span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded">{item.category}</span>
                                                                <span className="px-2 py-1 bg-gray-100 text-gray-700 rounded">{item.status}</span>
                                                                <span>{item.date}</span>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                {item.isManualEntry && (
                                                                    <>
                                                                        <button
                                                                            onClick={() => editManualEntry(item)}
                                                                            className="text-sm text-blue-600 hover:text-blue-800"
                                                                        >
                                                                            Edit
                                                                        </button>
                                                                        <button
                                                                            onClick={() => deleteManualEntry(item.id)}
                                                                            className="text-sm text-red-600 hover:text-red-800"
                                                                        >
                                                                            Delete
                                                                        </button>
                                                                    </>
                                                                )}
                                                                <button
                                                                    onClick={() => {
                                                                        setEditingNote(item.id);
                                                                        setNoteText(itemNotes[item.id] || '');
                                                                    }}
                                                                    className="text-sm text-indigo-600 hover:text-indigo-800"
                                                                >
                                                                    {itemNotes[item.id] ? 'Edit Note' : 'Add Note'}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showAddKeyword && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Keyword</h3>
                                <input
                                    type="text"
                                    value={newKeyword}
                                    onChange={(e) => setNewKeyword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addKeyword()}
                                    placeholder="e.g., education, healthcare"
                                    className="w-full px-3 py-2 border rounded-lg mb-4"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={addKeyword}
                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowAddKeyword(false);
                                            setNewKeyword('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddCommittee && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Committee</h3>
                                <p className="text-sm text-gray-600 mb-3">
                                    Enter the committee name. Try partial names like "Housing" or "Transportation"
                                </p>
                                <input
                                    type="text"
                                    value={newCommittee}
                                    onChange={(e) => setNewCommittee(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addCommittee()}
                                    placeholder="e.g., Housing, Transportation, Judiciary"
                                    className="w-full px-3 py-2 border rounded-lg mb-4"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={addCommittee}
                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowAddCommittee(false);
                                            setNewCommittee('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddSponsor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Sponsor</h3>
                                <p className="text-sm text-gray-600 mb-3">
                                    Enter the councilmember's last name or full name
                                </p>
                                <input
                                    type="text"
                                    value={newSponsor}
                                    onChange={(e) => setNewSponsor(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addSponsor()}
                                    placeholder="e.g., Allen, Nadeau, McDuffie"
                                    className="w-full px-3 py-2 border rounded-lg mb-4"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={addSponsor}
                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowAddSponsor(false);
                                            setNewSponsor('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingNote && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Note</h3>
                                <textarea
                                    value={noteText}
                                    onChange={(e) => setNoteText(e.target.value)}
                                    placeholder="Enter your notes..."
                                    className="w-full px-3 py-2 border rounded-lg mb-4 h-32"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={saveNote}
                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                    >
                                        Save
                                    </button>
                                    <button
                                        onClick={() => {
                                            setEditingNote(null);
                                            setNoteText('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showManualEntry && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
                                <h3 className="text-xl font-semibold mb-4">
                                    {editingManualEntry ? 'Edit DC Register Item' : 'Add DC Register Item'}
                                </h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Visit <a href="https://www.dcregs.dc.gov/" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">dcregs.dc.gov</a> to find recent regulations
                                </p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Title *</label>
                                        <input
                                            type="text"
                                            value={manualEntry.title}
                                            onChange={(e) => setManualEntry({...manualEntry, title: e.target.value})}
                                            placeholder="e.g., Department of Health - Notice of Final Rulemaking..."
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Notice ID</label>
                                            <input
                                                type="text"
                                                value={manualEntry.noticeId}
                                                onChange={(e) => setManualEntry({...manualEntry, noticeId: e.target.value})}
                                                placeholder="e.g., 2024-123"
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Register Issue</label>
                                            <input
                                                type="text"
                                                value={manualEntry.registerIssue}
                                                onChange={(e) => setManualEntry({...manualEntry, registerIssue: e.target.value})}
                                                placeholder="e.g., Vol. 71, No. 23"
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Agency</label>
                                        <input
                                            type="text"
                                            value={manualEntry.agency}
                                            onChange={(e) => setManualEntry({...manualEntry, agency: e.target.value})}
                                            placeholder="e.g., Department of Health"
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Status</label>
                                            <select
                                                value={manualEntry.status}
                                                onChange={(e) => setManualEntry({...manualEntry, status: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                <option>Notice</option>
                                                <option>Published</option>
                                                <option>Proposed</option>
                                                <option>Final Rulemaking</option>
                                                <option>Emergency</option>
                                                <option>Comment Period</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Date</label>
                                            <input
                                                type="date"
                                                value={manualEntry.date}
                                                onChange={(e) => setManualEntry({...manualEntry, date: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Register Notes</label>
                                        <textarea
                                            value={manualEntry.registerNotes}
                                            onChange={(e) => setManualEntry({...manualEntry, registerNotes: e.target.value})}
                                            placeholder="Paste text from the DC Register notice..."
                                            className="w-full px-3 py-2 border rounded-lg h-32"
                                        />
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Assigned To</label>
                                            <select
                                                value={manualEntry.assignedTo}
                                                onChange={(e) => setManualEntry({...manualEntry, assignedTo: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {teamMembers.map(member => (
                                                    <option key={member.id} value={member.name}>
                                                        {member.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Priority</label>
                                            <select
                                                value={manualEntry.priority}
                                                onChange={(e) => setManualEntry({...manualEntry, priority: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                <option value="high">High</option>
                                                <option value="medium">Medium</option>
                                                <option value="low">Low</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Action Status</label>
                                            <select
                                                value={manualEntry.actionStatus}
                                                onChange={(e) => setManualEntry({...manualEntry, actionStatus: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                <option value="action_needed">Action Needed</option>
                                                <option value="action_completed">Action Completed</option>
                                                <option value="monitor_and_assess">Monitor & Assess</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Link (optional)</label>
                                        <input
                                            type="url"
                                            value={manualEntry.link}
                                            onChange={(e) => setManualEntry({...manualEntry, link: e.target.value})}
                                            placeholder="https://www.dcregs.dc.gov/..."
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button
                                        onClick={editingManualEntry ? updateManualEntry : addManualEntry}
                                        className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                    >
                                        {editingManualEntry ? 'Update Item' : 'Add Item'}
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowManualEntry(false);
                                            setEditingManualEntry(null);
                                            setManualEntry({
                                                title: '',
                                                agency: '',
                                                status: 'Published',
                                                date: new Date().toISOString().split('T')[0],
                                                link: '',
                                                assignedTo: 'Unassigned',
                                                priority: 'medium',
                                                actionStatus: 'action_needed',
                                                noticeId: '',
                                                registerIssue: '',
                                                registerNotes: ''
                                            });
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showActivityLog && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Activity Log</h3>
                                    <button
                                        onClick={() => setShowActivityLog(false)}
                                        className="text-gray-500 hover:text-gray-700 text-2xl"
                                    >
                                        ×
                                    </button>
                                </div>
                                <div className="space-y-2">
                                    {activityLog.map((log) => (
                                        <div key={log.id} className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <span className="font-semibold text-sm">{log.action.replace(/_/g, ' ').toUpperCase()}</span>
                                                    {log.item_title && <span className="text-sm text-gray-600 ml-2">- {log.item_title}</span>}
                                                    {log.details && Object.keys(log.details).length > 0 && (
                                                        <div className="text-xs text-gray-500 mt-1">
                                                            {JSON.stringify(log.details)}
                                                        </div>
                                                    )}
                                                </div>
                                                <span className="text-xs text-gray-400">
                                                    {new Date(log.created_at).toLocaleString()}
                                                </span>
                                            </div>
                                        </div>
                                    ))}
                                    {activityLog.length === 0 && (
                                        <div className="text-center py-8 text-gray-500">
                                            No activity recorded yet
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {showEmailPreview && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Email Preview</h3>
                                    <button
                                        onClick={() => setShowEmailPreview(false)}
                                        className="text-gray-500 hover:text-gray-700 text-2xl"
                                    >
                                        ×
                                    </button>
                                </div>
                                <pre className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap font-mono mb-4">
                                    {generateEmailBody()}
                                </pre>
                                <div className="flex gap-2">
                                    <button
                                        onClick={copyEmailToClipboard}
                                        className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                    >
                                        Copy to Clipboard
                                    </button>
                                    <button
                                        onClick={() => setShowEmailPreview(false)}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTeamManagement && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Manage Team Members</h3>
                                    <button
                                        onClick={() => {
                                            setShowTeamManagement(false);
                                            setEditingTeamMember(null);
                                            setTeamMemberForm({ name: '', email: '' });
                                        }}
                                        className="text-gray-500 hover:text-gray-700 text-2xl"
                                    >
                                        ×
                                    </button>
                                </div>
                                
                                <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h4 className="font-semibold mb-3">
                                        {editingTeamMember ? 'Edit Team Member' : 'Add New Team Member'}
                                    </h4>
                                    <div className="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Name *</label>
                                            <input
                                                type="text"
                                                value={teamMemberForm.name}
                                                onChange={(e) => setTeamMemberForm({...teamMemberForm, name: e.target.value})}
                                                placeholder="e.g., John Doe"
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Email (optional)</label>
                                            <input
                                                type="email"
                                                value={teamMemberForm.email}
                                                onChange={(e) => setTeamMemberForm({...teamMemberForm, email: e.target.value})}
                                                placeholder="john@example.com"
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={editingTeamMember ? updateTeamMember : addTeamMember}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                        >
                                            {editingTeamMember ? 'Update' : 'Add Team Member'}
                                        </button>
                                        {editingTeamMember && (
                                            <button
                                                onClick={() => {
                                                    setEditingTeamMember(null);
                                                    setTeamMemberForm({ name: '', email: '' });
                                                }}
                                                className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                            >
                                                Cancel
                                            </button>
                                        )}
                                    </div>
                                </div>

                                <div className="space-y-2">
                                    <h4 className="font-semibold mb-2">Current Team Members</h4>
                                    {teamMembers.map(member => (
                                        <div key={member.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div>
                                                <div className="font-medium">{member.name}</div>
                                                {member.email && (
                                                    <div className="text-sm text-gray-600">{member.email}</div>
                                                )}
                                            </div>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => editTeamMember(member)}
                                                    className="px-3 py-1 text-sm text-blue-600 hover:text-blue-800"
                                                >
                                                    Edit
                                                </button>
                                                {member.name !== 'Unassigned' && (
                                                    <button
                                                        onClick={() => deleteTeamMember(member.id)}
                                                        className="px-3 py-1 text-sm text-red-600 hover:text-red-800"
                                                    >
                                                        Delete
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {teamMembers.length === 0 && (
                                        <div className="text-center py-8 text-gray-500">
                                            No team members yet. Add one above!
                                        </div>
                                    )}
                                </div>
                                
                                <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                                    <strong>Note:</strong> Editing a team member's name will update all items assigned to them. Deleting removes them from the dropdown but preserves existing assignments.
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<DCPolicyTracker />, document.getElementById('root'));
    </script>
</body>
</html>
