<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Policy Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        function DCPolicyTracker() {
            const [items, setItems] = useState([]);
            const [filters, setFilters] = useState({
                keywords: '',
                committee: 'all',
                category: 'all'
            });
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [itemNotes, setItemNotes] = useState({});
            const [trackedKeywords, setTrackedKeywords] = useState(['housing', 'transportation', 'environment']);
            const [councilPeriods, setCouncilPeriods] = useState([]);
            const [selectedPeriod, setSelectedPeriod] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showAddKeyword, setShowAddKeyword] = useState(false);
            const [newKeyword, setNewKeyword] = useState('');
            const [editingNote, setEditingNote] = useState(null);
            const [noteText, setNoteText] = useState('');
            const [showManualEntry, setShowManualEntry] = useState(false);
            const [manualEntry, setManualEntry] = useState({
                title: '',
                agency: '',
                status: 'Published',
                date: new Date().toISOString().split('T')[0],
                link: ''
            });

            const PROXY_URL = 'https://dc-lims-proxy.vercel.app/api/hello';

            useEffect(() => {
                loadFromStorage();
                loadCouncilPeriods();
            }, []);

            const loadFromStorage = () => {
                try {
                    const saved = localStorage.getItem('dc-tracker-data');
                    if (saved) {
                        const data = JSON.parse(saved);
                        setSelectedItems(new Set(data.selectedItems || []));
                        setItemNotes(data.itemNotes || {});
                        setTrackedKeywords(data.trackedKeywords || ['housing', 'transportation', 'environment']);
                    }
                } catch (e) {
                    console.error('Error loading from storage:', e);
                }
            };

            const saveToStorage = () => {
                try {
                    const data = {
                        selectedItems: Array.from(selectedItems),
                        itemNotes,
                        trackedKeywords
                    };
                    localStorage.setItem('dc-tracker-data', JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving to storage:', e);
                }
            };

            useEffect(() => {
                saveToStorage();
            }, [selectedItems, itemNotes, trackedKeywords]);

            const proxyFetch = async (endpoint, method = 'GET', body = null) => {
                try {
                    const params = new URLSearchParams({ endpoint, method });
                    if (body) params.append('body', JSON.stringify(body));
                    
                    const url = `${PROXY_URL}?${params.toString()}`;
                    console.log('Fetching from proxy:', url);
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    console.log('Proxy response:', data);
                    
                    if (data.error) throw new Error(data.error);
                    return data;
                } catch (error) {
                    console.error('Proxy fetch error:', error);
                    throw error;
                }
            };

            const loadCouncilPeriods = async () => {
                try {
                    setLoading(true);
                    const data = await proxyFetch('/CouncilPeriods');
                    setCouncilPeriods(data);
                    if (data.length > 0) {
                        setSelectedPeriod(data[0]);
                    }
                    setLoading(false);
                } catch (err) {
                    setError('Failed to load council periods: ' + err.message);
                    setLoading(false);
                }
            };

            const refreshData = async () => {
                if (!selectedPeriod) return;
                
                setLoading(true);
                setError(null);
                
                try {
                    console.log('Starting search with council period:', selectedPeriod.councilPeriodId);
                    
                    const searchPromises = trackedKeywords.map(keyword =>
                        proxyFetch('/SearchLegislation', 'POST', {
                            Keyword: keyword,
                            CategoryId: 0,
                            CouncilPeriodId: selectedPeriod.councilPeriodId,
                            RowLimit: 20,
                            OffSet: 0
                        }).catch(err => {
                            console.error(`Error searching for "${keyword}":`, err);
                            return { legislationSearchResults: [] };
                        })
                    );

                    const results = await Promise.all(searchPromises);
                    console.log('Search results:', results);
                    
                    const allLegislation = [];
                    const seenIds = new Set();
                    
                    results.forEach(result => {
                        if (result && result.legislationSearchResults) {
                            result.legislationSearchResults.forEach(leg => {
                                if (!seenIds.has(leg.legislationNumber)) {
                                    seenIds.add(leg.legislationNumber);
                                    allLegislation.push(leg);
                                }
                            });
                        }
                    });

                    console.log('Total unique legislation found:', allLegislation.length);

                    const transformedItems = allLegislation.map(leg => ({
                        id: leg.legislationNumber,
                        title: leg.title,
                        billNumber: leg.legislationNumber,
                        category: leg.legislationCategoryName || 'Unknown',
                        status: leg.currentStatus || 'Unknown',
                        committees: leg.introCommittee ? [leg.introCommittee] : [],
                        date: leg.introductionDate ? new Date(leg.introductionDate).toISOString().split('T')[0] : '',
                        description: leg.shortTitle || leg.title,
                        link: `https://lims.dccouncil.gov/Legislation/${leg.legislationNumber}`,
                        source: 'DC Council',
                        isNew: isNewItem(leg.introductionDate)
                    }));

                    console.log('Transformed items:', transformedItems.length);
                    setItems(transformedItems);
                    setLoading(false);
                } catch (err) {
                    console.error('Error in refreshData:', err);
                    setError('Failed to fetch legislation: ' + err.message);
                    setLoading(false);
                }
            };

            const isNewItem = (dateString) => {
                if (!dateString) return false;
                const itemDate = new Date(dateString);
                const daysSince = (new Date() - itemDate) / (1000 * 60 * 60 * 24);
                return daysSince <= 7;
            };

            const toggleSelection = (itemId) => {
                const newSelected = new Set(selectedItems);
                if (newSelected.has(itemId)) {
                    newSelected.delete(itemId);
                } else {
                    newSelected.add(itemId);
                }
                setSelectedItems(newSelected);
            };

            const saveNote = () => {
                if (editingNote) {
                    setItemNotes({...itemNotes, [editingNote]: noteText});
                    setEditingNote(null);
                    setNoteText('');
                }
            };

            const deleteNote = (itemId) => {
                const newNotes = {...itemNotes};
                delete newNotes[itemId];
                setItemNotes(newNotes);
            };

            const addKeyword = () => {
                if (newKeyword.trim() && !trackedKeywords.includes(newKeyword.toLowerCase())) {
                    setTrackedKeywords([...trackedKeywords, newKeyword.toLowerCase()]);
                    setNewKeyword('');
                    setShowAddKeyword(false);
                }
            };

            const removeKeyword = (keyword) => {
                setTrackedKeywords(trackedKeywords.filter(k => k !== keyword));
            };

            const addManualEntry = () => {
                if (!manualEntry.title.trim()) {
                    alert('Please enter a title');
                    return;
                }

                const newItem = {
                    id: `MANUAL-${Date.now()}`,
                    title: manualEntry.title,
                    agency: manualEntry.agency || 'DC Government',
                    category: 'Municipal Regulation',
                    status: manualEntry.status,
                    date: manualEntry.date,
                    description: manualEntry.title,
                    link: manualEntry.link,
                    source: 'Municipal Register',
                    isNew: isWithinDays(manualEntry.date, 7),
                    committees: []
                };

                setItems([newItem, ...items]);
                setShowManualEntry(false);
                setManualEntry({
                    title: '',
                    agency: '',
                    status: 'Published',
                    date: new Date().toISOString().split('T')[0],
                    link: ''
                });
            };

            const exportToCSV = () => {
                const headers = ['Title', 'Bill Number', 'Category', 'Status', 'Committees', 'Date', 'Link', 'Notes', 'Action Required'];
                const rows = filteredItems.map(item => [
                    item.title,
                    item.billNumber || '',
                    item.category,
                    item.status,
                    item.committees ? item.committees.join('; ') : '',
                    item.date,
                    item.link || '',
                    itemNotes[item.id] || '',
                    selectedItems.has(item.id) ? 'Yes' : 'No'
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dc-policy-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            const filteredItems = items.filter(item => {
                const matchesKeyword = !filters.keywords || 
                    item.title.toLowerCase().includes(filters.keywords.toLowerCase()) ||
                    item.description.toLowerCase().includes(filters.keywords.toLowerCase());
                const matchesCommittee = filters.committee === 'all' || 
                    (item.committees && item.committees.some(c => c === filters.committee));
                const matchesCategory = filters.category === 'all' || item.category === filters.category;
                return matchesKeyword && matchesCommittee && matchesCategory;
            });

            const categories = ['all', ...new Set(items.map(i => i.category))];
            const committees = ['all', ...new Set(items.filter(i => i.committees).flatMap(i => i.committees))];

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">DC Policy Tracker</h1>
                                    <p className="text-gray-600">Legislative Monitoring System</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={exportToCSV}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                    >
                                        Export CSV
                                    </button>
                                    <button
                                        onClick={refreshData}
                                        disabled={loading}
                                        className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400"
                                    >
                                        {loading ? 'Loading...' : 'Refresh'}
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4">
                                    {error}
                                </div>
                            )}

                            {selectedPeriod && (
                                <div className="text-sm text-gray-600">
                                    Council Period: <strong>{selectedPeriod.councilPeriod}</strong> | 
                                    {selectedItems.size > 0 && <span className="ml-2 px-2 py-1 bg-indigo-100 text-indigo-700 rounded">{selectedItems.size} items need action</span>}
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Keywords</h2>
                                        <button
                                            onClick={() => setShowAddKeyword(true)}
                                            className="text-indigo-600 hover:text-indigo-800"
                                        >
                                            + Add
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        {trackedKeywords.map(keyword => (
                                            <div key={keyword} className="flex items-center justify-between p-2 bg-indigo-50 rounded">
                                                <span className="capitalize">{keyword}</span>
                                                <button
                                                    onClick={() => removeKeyword(keyword)}
                                                    className="text-red-600 hover:text-red-800"
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">Filters</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Search</label>
                                            <input
                                                type="text"
                                                value={filters.keywords}
                                                onChange={(e) => setFilters({...filters, keywords: e.target.value})}
                                                placeholder="Search..."
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Category</label>
                                            <select
                                                value={filters.category}
                                                onChange={(e) => setFilters({...filters, category: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {categories.map(cat => (
                                                    <option key={cat} value={cat}>{cat}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Committee</label>
                                            <select
                                                value={filters.committee}
                                                onChange={(e) => setFilters({...filters, committee: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                {committees.map(com => (
                                                    <option key={com} value={com}>{com}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">
                                        Legislation ({filteredItems.length})
                                    </h2>

                                    {loading && (
                                        <div className="text-center py-12 text-gray-500">
                                            Loading legislation...
                                        </div>
                                    )}

                                    {!loading && filteredItems.length === 0 && (
                                        <div className="text-center py-12 text-gray-500">
                                            Click Refresh to load legislation
                                        </div>
                                    )}

                                    <div className="space-y-4">
                                        {filteredItems.map(item => (
                                            <div
                                                key={item.id}
                                                className={`p-4 border-2 rounded-lg ${
                                                    item.isNew ? 'border-red-200 bg-red-50' : 'border-gray-200'
                                                } ${selectedItems.has(item.id) ? 'ring-2 ring-indigo-400' : ''}`}
                                            >
                                                <div className="flex items-start gap-3">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedItems.has(item.id)}
                                                        onChange={() => toggleSelection(item.id)}
                                                        className="mt-1"
                                                    />
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            {item.isNew && (
                                                                <span className="px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded">
                                                                    NEW
                                                                </span>
                                                            )}
                                                            {selectedItems.has(item.id) && (
                                                                <span className="px-2 py-0.5 bg-indigo-500 text-white text-xs font-bold rounded">
                                                                    ACTION REQUIRED
                                                                </span>
                                                            )}
                                                            <h3 className="font-semibold">{item.title}</h3>
                                                        </div>
                                                        <div className="text-xs text-gray-500 mb-2">
                                                            <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">
                                                                {item.billNumber}
                                                            </a>
                                                        </div>
                                                        <p className="text-sm text-gray-600 mb-2">{item.description}</p>

                                                        {item.committees && item.committees.length > 0 && (
                                                            <div className="mb-2">
                                                                <div className="text-xs font-semibold mb-1">Committees:</div>
                                                                <div className="flex flex-wrap gap-1">
                                                                    {item.committees.map(com => (
                                                                        <span key={com} className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">
                                                                            {com}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}

                                                        {itemNotes[item.id] && (
                                                            <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                                                <div className="flex justify-between">
                                                                    <div>
                                                                        <div className="text-xs font-semibold text-yellow-800 mb-1">Note:</div>
                                                                        <p className="text-sm">{itemNotes[item.id]}</p>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => deleteNote(item.id)}
                                                                        className="text-red-600 hover:text-red-800"
                                                                    >
                                                                        ×
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        )}

                                                        <div className="flex items-center justify-between mt-2">
                                                            <div className="flex items-center gap-4 text-xs text-gray-500">
                                                                <span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded">{item.category}</span>
                                                                <span className="px-2 py-1 bg-gray-100 text-gray-700 rounded">{item.status}</span>
                                                                <span>{item.date}</span>
                                                            </div>
                                                            <button
                                                                onClick={() => {
                                                                    setEditingNote(item.id);
                                                                    setNoteText(itemNotes[item.id] || '');
                                                                }}
                                                                className="text-sm text-indigo-600 hover:text-indigo-800"
                                                            >
                                                                {itemNotes[item.id] ? 'Edit Note' : 'Add Note'}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showAddKeyword && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Keyword</h3>
                                <input
                                    type="text"
                                    value={newKeyword}
                                    onChange={(e) => setNewKeyword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && addKeyword()}
                                    placeholder="e.g., education, healthcare"
                                    className="w-full px-3 py-2 border rounded-lg mb-4"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={addKeyword}
                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                    >
                                        Add
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowAddKeyword(false);
                                            setNewKeyword('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingNote && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Note</h3>
                                <textarea
                                    value={noteText}
                                    onChange={(e) => setNoteText(e.target.value)}
                                    placeholder="Enter your notes..."
                                    className="w-full px-3 py-2 border rounded-lg mb-4 h-32"
                                    autoFocus
                                />
                                <div className="flex gap-2">
                                    <button
                                        onClick={saveNote}
                                        className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                    >
                                        Save
                                    </button>
                                    <button
                                        onClick={() => {
                                            setEditingNote(null);
                                            setNoteText('');
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showManualEntry && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                <h3 className="text-xl font-semibold mb-4">Add DC Register Item</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Visit <a href="https://www.dcregs.dc.gov/" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">dcregs.dc.gov</a> to find recent regulations
                                </p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Title *</label>
                                        <input
                                            type="text"
                                            value={manualEntry.title}
                                            onChange={(e) => setManualEntry({...manualEntry, title: e.target.value})}
                                            placeholder="e.g., Department of Health - Notice of Final Rulemaking..."
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Agency</label>
                                        <input
                                            type="text"
                                            value={manualEntry.agency}
                                            onChange={(e) => setManualEntry({...manualEntry, agency: e.target.value})}
                                            placeholder="e.g., Department of Health"
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Status</label>
                                            <select
                                                value={manualEntry.status}
                                                onChange={(e) => setManualEntry({...manualEntry, status: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            >
                                                <option>Published</option>
                                                <option>Proposed</option>
                                                <option>Final Rulemaking</option>
                                                <option>Emergency</option>
                                                <option>Comment Period</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Date</label>
                                            <input
                                                type="date"
                                                value={manualEntry.date}
                                                onChange={(e) => setManualEntry({...manualEntry, date: e.target.value})}
                                                className="w-full px-3 py-2 border rounded-lg"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Link (optional)</label>
                                        <input
                                            type="url"
                                            value={manualEntry.link}
                                            onChange={(e) => setManualEntry({...manualEntry, link: e.target.value})}
                                            placeholder="https://www.dcregs.dc.gov/..."
                                            className="w-full px-3 py-2 border rounded-lg"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button
                                        onClick={addManualEntry}
                                        className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                    >
                                        Add Item
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowManualEntry(false);
                                            setManualEntry({
                                                title: '',
                                                agency: '',
                                                status: 'Published',
                                                date: new Date().toISOString().split('T')[0],
                                                link: ''
                                            });
                                        }}
                                        className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<DCPolicyTracker />, document.getElementById('root'));
    </script>
</body>
</html>
