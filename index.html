<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Policy Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://owqylzpuxwsldepufxep.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_IWFsW7Fp1xUzKkr82yVavw_wu236ZdP';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ─── Hearing parser ───────────────────────────────────────────────────────────
        function extractNextHearing(details) {
            const now = new Date();
            const candidates = [];

            // committeeHearing — the primary field the DC Council API uses
            const committeeHearings = details.committeeHearing || [];
            if (Array.isArray(committeeHearings)) {
                committeeHearings.forEach(h => {
                    if (!h.hearingDate) return;
                    const d = new Date(h.hearingDate);
                    if (!isNaN(d)) candidates.push({
                        date: d,
                        type: h.hearingType || 'Committee Hearing',
                        location: h.location || h.room || ''
                    });
                });
            }

            // committeeMarkup
            const markups = details.committeeMarkup || [];
            if (Array.isArray(markups)) {
                markups.forEach(h => {
                    if (!h.hearingDate) return;
                    const d = new Date(h.hearingDate);
                    if (!isNaN(d)) candidates.push({ date: d, type: h.hearingType || 'Committee Markup', location: h.location || '' });
                });
            }

            // Flat fields as fallback
            for (const f of ['nextHearingDate', 'hearingDate', 'committeeHearingDate', 'scheduledHearingDate']) {
                if (details[f]) {
                    const d = new Date(details[f]);
                    if (!isNaN(d)) candidates.push({ date: d, type: 'Hearing', location: details.hearingLocation || '' });
                }
            }

            // legislativeHistory / actions as fallback
            const hearingKeywords = ['hearing', 'markup', 'public hearing', 'oversight hearing'];
            const history = details.legislativeHistory || details.history || details.actions || details.events || [];
            if (Array.isArray(history)) {
                history.forEach(event => {
                    const action = (event.action || event.actionType || event.eventType || event.description || event.name || '').toLowerCase();
                    if (!hearingKeywords.some(k => action.includes(k))) return;
                    const rawDate = event.date || event.actionDate || event.eventDate || event.scheduledDate || event.hearingDate;
                    if (!rawDate) return;
                    const d = new Date(rawDate);
                    if (!isNaN(d)) candidates.push({
                        date: d,
                        type: event.action || event.actionType || event.eventType || 'Hearing',
                        location: event.location || event.room || event.hearingLocation || ''
                    });
                });
            }

            if (!candidates.length) return { date: null, dateStr: null, timeStr: null, type: null, location: null, isPast: null, allFuture: [] };

            candidates.sort((a, b) => a.date - b.date);
            const future = candidates.filter(c => c.date > now);
            const best = future.length > 0 ? future[0] : candidates[candidates.length - 1];

            return {
                date: best.date,
                dateStr: best.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }),
                timeStr: best.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                type: best.type,
                location: best.location,
                isPast: best.date <= now,
                allFuture: future.map(c => ({
                    dateStr: c.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                    timeStr: c.date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                    type: c.type,
                    location: c.location
                }))
            };
        }

        // ─── Latest LIMS activity date ────────────────────────────────────────────────
        function extractLatestActivityDate(details) {
            const candidates = [];

            const add = (val, label) => {
                if (!val) return;
                const d = new Date(val);
                if (!isNaN(d) && d.getFullYear() > 2000) candidates.push({ date: d, label });
            };

            // Congressional review
            if (details.congressionalReview) {
                add(details.congressionalReview.effectiveDate, 'Effective Date (Law)');
                add(details.congressionalReview.lawPublicationDate, 'Law Published');
                add(details.congressionalReview.transmittedDate, 'Transmitted to Congress');
            }

            // Mayoral review
            if (details.mayoralReview) {
                add(details.mayoralReview.enactedDate, 'Enacted');
                add(details.mayoralReview.signedDate, 'Signed by Mayor');
                add(details.mayoralReview.returnedDate, 'Returned by Mayor');
                add(details.mayoralReview.actPublicationDate, 'Act Published');
                add(details.mayoralReview.transmittedDate, 'Transmitted to Mayor');
            }

            // Council actions (votes)
            (details.actions || []).forEach(a => add(a.actionDate, a.action?.trim() || 'Council Action'));

            // Committee markups
            (details.committeeMarkup || []).forEach(m => {
                add(m.reportFiledDate, 'Committee Report Filed');
                add(m.committeeActionDate, 'Committee Markup');
            });

            // Past hearings
            (details.committeeHearing || []).forEach(h => {
                if (new Date(h.hearingDate) <= new Date()) add(h.hearingDate, h.hearingType || 'Committee Hearing');
            });

            // Re-referrals
            (details.committeeReReferral || []).forEach(r => {
                add(r.reReferralDate, 'Committee Re-Referral');
                add(r.reReferralPublishedDate, 'Re-Referral Published');
            });

            // Introduction dates as floor
            add(details.introductionPublicationDate, 'Introduction Published');
            add(details.introductionDate, 'Introduced');

            if (!candidates.length) return null;
            candidates.sort((a, b) => b.date - a.date);
            const best = candidates[0];
            return { date: best.date, dateIso: best.date.toISOString(), label: best.label };
        }

        // ─── Full LIMS activity timeline ──────────────────────────────────────────────
        function extractActivityTimeline(details) {
            const events = [];
            const add = (val, label, extra) => {
                if (!val) return;
                const d = new Date(val);
                if (!isNaN(d) && d.getFullYear() > 2000) events.push({ date: d, label, extra: extra || null });
            };

            add(details.introductionDate, 'Introduced');
            add(details.committeeReferralDate, 'Referred to Committee');
            add(details.introductionPublicationDate, 'Introduction Published');

            (details.committeeReReferral || []).forEach(r => {
                const committee = Array.isArray(r.committeeName) ? r.committeeName.join(', ') : (r.committeeName || '');
                add(r.reReferralDate, 'Committee Re-Referral', committee);
                add(r.reReferralPublishedDate, 'Re-Referral Published', committee);
            });

            (details.committeeHearing || []).forEach(h => {
                add(h.noticeFiledDate, `${h.hearingType || 'Hearing'} Notice Filed`);
                add(h.hearingDate, h.hearingType || 'Committee Hearing');
            });

            (details.committeeMarkup || []).forEach(m => {
                add(m.committeeActionDate, 'Committee Markup');
                add(m.reportFiledDate, 'Committee Report Filed');
            });

            (details.actions || []).forEach(a => {
                const voteResult = a.voteDetails?.voteResult;
                add(a.actionDate, a.action?.trim() || 'Council Action', voteResult || null);
            });

            if (details.mayoralReview) {
                add(details.mayoralReview.transmittedDate, 'Transmitted to Mayor');
                add(details.mayoralReview.signedDate, 'Signed by Mayor');
                add(details.mayoralReview.returnedDate, 'Returned by Mayor');
                add(details.mayoralReview.enactedDate, 'Enacted');
                add(details.mayoralReview.actPublicationDate, 'Act Published');
            }

            if (details.congressionalReview) {
                add(details.congressionalReview.transmittedDate, 'Transmitted to Congress');
                add(details.congressionalReview.effectiveDate, 'Effective Date (Law)');
                add(details.congressionalReview.lawPublicationDate, 'Law Published');
            }

            // Deduplicate by date+label, sort chronologically
            const seen = new Set();
            return events
                .filter(e => { const k = `${e.date.getTime()}::${e.label}`; if (seen.has(k)) return false; seen.add(k); return true; })
                .sort((a, b) => a.date - b.date)
                .map(e => ({
                    dateStr: e.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                    label: e.label,
                    extra: e.extra,
                    isFuture: e.date > new Date()
                }));
        }

        function DCPolicyTracker() {
            const [items, setItems] = useState([]);
            const [filters, setFilters] = useState({
                keywords: '',
                committee: 'all',
                category: 'all',
                assignedTo: 'all',
                priority: 'all',
                actionStatus: 'all',
                introducedBy: 'all',
                hideTrackedItems: false,
                hasUpcomingHearing: false
            });
            const [selectedItems, setSelectedItems] = useState(new Set());
            const [itemNotes, setItemNotes] = useState({});
            const [trackedKeywords, setTrackedKeywords] = useState([]);
            const [trackedCommittees, setTrackedCommittees] = useState([]);
            const [trackedSponsors, setTrackedSponsors] = useState([]);
            const [searchMode, setSearchMode] = useState('all');
            const [teamMembers, setTeamMembers] = useState([]);
            const [searchOffset, setSearchOffset] = useState(0);
            const [hasMoreResults, setHasMoreResults] = useState(true);
            const [currentSearchCategory, setCurrentSearchCategory] = useState(null);
            const [councilPeriods, setCouncilPeriods] = useState([]);
            const [selectedPeriod, setSelectedPeriod] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showAddKeyword, setShowAddKeyword] = useState(false);
            const [showAddCommittee, setShowAddCommittee] = useState(false);
            const [showAddSponsor, setShowAddSponsor] = useState(false);
            const [newKeyword, setNewKeyword] = useState('');
            const [newCommittee, setNewCommittee] = useState('');
            const [newSponsor, setNewSponsor] = useState('');
            const [editingNote, setEditingNote] = useState(null);
            const [noteText, setNoteText] = useState('');
            const [editingSummary, setEditingSummary] = useState(null);
            const [summaryText, setSummaryText] = useState('');
            const [showManualEntry, setShowManualEntry] = useState(false);
            const [editingManualEntry, setEditingManualEntry] = useState(null);
            const [showActivityLog, setShowActivityLog] = useState(false);
            const [showEmailPreview, setShowEmailPreview] = useState(false);
            const [showTeamManagement, setShowTeamManagement] = useState(false);
            const [editingTeamMember, setEditingTeamMember] = useState(null);
            const [teamMemberForm, setTeamMemberForm] = useState({ name: '', email: '' });
            const [activityLog, setActivityLog] = useState([]);
            const [manualEntry, setManualEntry] = useState({
                title: '', agency: '', status: 'Published',
                date: new Date().toISOString().split('T')[0],
                link: '', assignedTo: 'Unassigned', priority: 'medium',
                actionStatus: 'action_needed', noticeId: '', registerIssue: '', registerNotes: '', deadline: ''
            });

            // ── Hearing state ─────────────────────────────────────────────────────────
            const [hearingData, setHearingData] = useState({});
            const [checkingHearings, setCheckingHearings] = useState(false);
            const [hearingCheckProgress, setHearingCheckProgress] = useState({ done: 0, total: 0 });
            const [showHearingPanel, setShowHearingPanel] = useState(false);

            // ── UI state ──────────────────────────────────────────────────────────────
            const [expandedInfo, setExpandedInfo] = useState(new Set());
            const [sortByActivity, setSortByActivity] = useState(false);
            const [activityFilter, setActivityFilter] = useState('all'); // 'all' | '7' | '30' | '90'
            const [statusHistory, setStatusHistory] = useState({}); // item_id -> [{old_status, new_status, changed_at, change_label}]
            const [expandedHistory, setExpandedHistory] = useState(new Set());

            const PROXY_URL = 'https://dcpca-policy-tracker.vercel.app/api/hello';

            useEffect(() => {
                loadFromSupabase();
                loadCouncilPeriods();
            }, []);

            const loadFromSupabase = async () => {
                try {
                    const { data: trackedData, error: trackedError } = await supabase
                        .from('tracked_items').select('*').order('tracked_at', { ascending: false });
                    if (trackedError) throw trackedError;

                    if (trackedData) {
                        const itemsSet = new Set(trackedData.map(item => item.id));
                        setSelectedItems(itemsSet);

                        const displayItems = trackedData.map(item => ({
                            id: item.id, title: item.title, billNumber: item.bill_number,
                            category: item.category, status: item.status,
                            committees: item.committees || [], date: item.date,
                            description: item.description, link: item.link,
                            source: item.source, agency: item.agency, isNew: item.is_new,
                            assignedTo: item.assigned_to, priority: item.priority,
                            actionStatus: item.action_status || 'action_needed',
                            introducedBy: item.introduced_by,
                            hasNewActivity: item.has_new_activity || false,
                            activitySummary: item.activity_summary || null,
                            lastStatus: item.last_status || null,
                            lastCheckedAt: item.last_checked_at,
                            noticeId: item.notice_id || null,
                            registerIssue: item.register_issue || null,
                            registerNotes: item.register_notes || null,
                            isManualEntry: item.is_manual_entry || false,
                            additionalInformation: item.additional_information || null,
                            manualSummary: item.manual_summary || null,
                            activityTimeline: item.activity_timeline || null,
                            committeeReReferral: item.committee_re_referral || [],
                            latestActivityDate: item.latest_activity_date || item.date || null,
                            latestActivityLabel: item.latest_activity_label || null,
                            activityCount: item.activity_count || 0,
                            deadline: item.deadline || null
                        }));
                        setItems(displayItems);

                        // Restore cached hearing data from Supabase columns
                        const hearingMap = {};
                        trackedData.forEach(item => {
                            if (item.next_hearing_date) {
                                const d = new Date(item.next_hearing_date);
                                hearingMap[item.id] = {
                                    date: d,
                                    dateStr: d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }),
                                    timeStr: d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                                    type: item.hearing_type || 'Hearing',
                                    location: item.hearing_location || '',
                                    isPast: d <= new Date(),
                                    checkedAt: item.hearing_checked_at || null,
                                    allFuture: []
                                };
                            }
                        });
                        if (Object.keys(hearingMap).length > 0) setHearingData(hearingMap);
                    }

                    const { data: notesData, error: notesError } = await supabase.from('item_notes').select('*');
                    if (notesError) throw notesError;
                    if (notesData) {
                        const notesMap = {};
                        notesData.forEach(note => { notesMap[note.item_id] = note.note_text; });
                        setItemNotes(notesMap);
                    }

                    const { data: keywordsData, error: keywordsError } = await supabase
                        .from('tracked_keywords').select('*').order('added_at', { ascending: true });
                    if (keywordsError) throw keywordsError;
                    if (keywordsData) setTrackedKeywords(keywordsData.map(k => k.keyword));

                    const { data: committeesData, error: committeesError } = await supabase
                        .from('tracked_committees').select('*').order('added_at', { ascending: true });
                    if (committeesError) throw committeesError;
                    if (committeesData) setTrackedCommittees(committeesData.map(c => c.committee_name));

                    const { data: sponsorsData, error: sponsorsError } = await supabase
                        .from('tracked_sponsors').select('*').order('added_at', { ascending: true });
                    if (sponsorsError) throw sponsorsError;
                    if (sponsorsData) setTrackedSponsors(sponsorsData.map(s => s.sponsor_name));

                    const { data: membersData, error: membersError } = await supabase
                        .from('team_members').select('*').eq('active', true).order('name', { ascending: true });
                    if (membersError) throw membersError;
                    if (membersData) setTeamMembers(membersData);

                    // Load status history
                    const { data: historyData } = await supabase
                        .from('bill_status_history').select('*').order('changed_at', { ascending: false });
                    if (historyData) {
                        const histMap = {};
                        historyData.forEach(h => {
                            if (!histMap[h.item_id]) histMap[h.item_id] = [];
                            histMap[h.item_id].push(h);
                        });
                        setStatusHistory(histMap);
                    }

                } catch (err) {
                    console.error('Error loading from Supabase:', err);
                    setError('Failed to load data: ' + err.message);
                }
            };

            const logActivity = async (action, itemId, itemTitle, details = {}) => {
                try {
                    const { error } = await supabase.from('activity_log').insert({ action, item_id: itemId, item_title: itemTitle, details });
                    if (error) console.error('Error logging activity:', error);
                } catch (err) { console.error('Error logging activity:', err); }
            };

            const loadActivityLog = async () => {
                try {
                    const { data, error } = await supabase.from('activity_log').select('*')
                        .order('created_at', { ascending: false }).limit(100);
                    if (error) throw error;
                    setActivityLog(data || []);
                } catch (err) { console.error('Error loading activity log:', err); }
            };

            const proxyFetch = async (endpoint, method = 'GET', body = null) => {
                try {
                    const response = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ endpoint, method, body })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    return data;
                } catch (error) {
                    console.error('Proxy fetch error:', error);
                    throw error;
                }
            };

            const loadCouncilPeriods = async () => {
                try {
                    setLoading(true);
                    const data = await proxyFetch('/CouncilPeriods');
                    setCouncilPeriods(data);
                    if (data.length > 0) setSelectedPeriod(data[0]);
                    setLoading(false);
                } catch (err) {
                    setError('Failed to load council periods: ' + err.message);
                    setLoading(false);
                }
            };

            // ── Hearing functions ─────────────────────────────────────────────────────

            const fetchLegislationDetails = async (legislationNumber) => {
                return await proxyFetch(`/LegislationDetails/${legislationNumber}`, 'GET');
            };

            const checkHearingsForTrackedItems = async () => {
                const trackedIds = items
                    .filter(item => selectedItems.has(item.id) && !item.isManualEntry)
                    .map(item => item.id);

                if (trackedIds.length === 0) {
                    setError('No tracked legislation items to check.');
                    return;
                }

                setCheckingHearings(true);
                setHearingCheckProgress({ done: 0, total: trackedIds.length });
                setError(null);

                const BATCH_SIZE = 1;
                const newHearingData = { ...hearingData };
                const now = new Date().toISOString();

                for (let i = 0; i < trackedIds.length; i += BATCH_SIZE) {
                    const batch = trackedIds.slice(i, i + BATCH_SIZE);
                    await Promise.all(batch.map(async (id) => {
                        try {
                            const details = await fetchLegislationDetails(id);
                            const hearing = extractNextHearing(details);
                            const reReferrals = details.committeeReReferral || [];
                            const currentItem = items.find(i => i.id === id);
                            let activityCount = currentItem?.activityCount || 0;
                            if (details.status && currentItem?.lastStatus && details.status !== currentItem.lastStatus) activityCount++;
                            if (reReferrals.length > (currentItem?.committeeReReferral?.length || 0)) activityCount++;
                            const latestActivity = extractLatestActivityDate(details);
                            const latestActivityDate = latestActivity?.dateIso || currentItem?.latestActivityDate || null;
                            const latestActivityLabel = latestActivity?.label || currentItem?.latestActivityLabel || null;
                            const activityTimeline = extractActivityTimeline(details);

                            newHearingData[id] = { ...hearing, checkedAt: now };
                            await supabase.from('tracked_items').update({
                                hearing_checked_at: now,
                                next_hearing_date: hearing.date ? hearing.date.toISOString() : null,
                                hearing_type: hearing.type || null,
                                hearing_location: hearing.location || null,
                                additional_information: details.additionalInformation || null,
                                committee_re_referral: reReferrals.length > 0 ? reReferrals : null,
                                latest_activity_date: latestActivityDate,
                                latest_activity_label: latestActivityLabel,
                                activity_count: activityCount,
                                activity_timeline: activityTimeline.length > 0 ? activityTimeline : null,
                                ...(details.status ? { status: details.status } : {})
                            }).eq('id', id);

                            setItems(prev => prev.map(i => i.id === id ? {
                                ...i,
                                additionalInformation: details.additionalInformation || i.additionalInformation,
                                committeeReReferral: reReferrals,
                                latestActivityDate: latestActivityDate,
                                latestActivityLabel: latestActivityLabel,
                                activityCount: activityCount,
                                activityTimeline: activityTimeline.length > 0 ? activityTimeline : i.activityTimeline,
                                status: details.status || i.status
                            } : i));
                        } catch (err) {
                            console.error(`Error fetching details for ${id}:`, err);
                            newHearingData[id] = { date: null, dateStr: null, type: null, location: null, isPast: null, error: err.message, checkedAt: now };
                        }
                    }));
                    setHearingData({ ...newHearingData });
                    setHearingCheckProgress({ done: Math.min(i + BATCH_SIZE, trackedIds.length), total: trackedIds.length });
                    if (i + BATCH_SIZE < trackedIds.length) await new Promise(r => setTimeout(r, 1500));
                }

                setCheckingHearings(false);
                setShowHearingPanel(true);
                const withHearings = Object.values(newHearingData).filter(h => h.date && !h.isPast).length;
                await logActivity('hearings_checked', null, null, { checked: trackedIds.length, withUpcoming: withHearings });
            };

            const checkHearingForItem = async (itemId) => {
                try {
                    const details = await fetchLegislationDetails(itemId);
                    const hearing = extractNextHearing(details);
                    const now = new Date().toISOString();
                    const reReferrals = details.committeeReReferral || [];
                    const currentItem = items.find(i => i.id === itemId);
                    let activityCount = currentItem?.activityCount || 0;
                    if (details.status && currentItem?.lastStatus && details.status !== currentItem.lastStatus) activityCount++;
                    if (reReferrals.length > (currentItem?.committeeReReferral?.length || 0)) activityCount++;
                    const latestActivity = extractLatestActivityDate(details);
                    const latestActivityDate = latestActivity?.dateIso || currentItem?.latestActivityDate || null;
                    const latestActivityLabel = latestActivity?.label || currentItem?.latestActivityLabel || null;

                    const activityTimeline = extractActivityTimeline(details);
                    setHearingData(prev => ({ ...prev, [itemId]: { ...hearing, checkedAt: now } }));
                    setItems(prev => prev.map(i => i.id === itemId ? {
                        ...i,
                        additionalInformation: details.additionalInformation || i.additionalInformation,
                        committeeReReferral: reReferrals,
                        latestActivityDate: latestActivityDate,
                        latestActivityLabel: latestActivityLabel,
                        activityCount: activityCount,
                        activityTimeline: activityTimeline.length > 0 ? activityTimeline : i.activityTimeline,
                        status: details.status || i.status
                    } : i));
                    await supabase.from('tracked_items').update({
                        hearing_checked_at: now,
                        next_hearing_date: hearing.date ? hearing.date.toISOString() : null,
                        hearing_type: hearing.type || null,
                        hearing_location: hearing.location || null,
                        additional_information: details.additionalInformation || null,
                        committee_re_referral: reReferrals.length > 0 ? reReferrals : null,
                        latest_activity_date: latestActivityDate,
                        latest_activity_label: latestActivityLabel,
                        activity_count: activityCount,
                        activity_timeline: activityTimeline.length > 0 ? activityTimeline : null,
                        ...(details.status ? { status: details.status } : {})
                    }).eq('id', itemId);
                } catch (err) { console.error(`Error checking hearing for ${itemId}:`, err); }
            };

            const itemsWithUpcomingHearings = items
                .filter(item => selectedItems.has(item.id))
                .map(item => ({ item, hearing: hearingData[item.id] }))
                .filter(({ hearing }) => hearing && hearing.date && !hearing.isPast)
                .sort((a, b) => a.hearing.date - b.hearing.date);

            const upcomingHearingCount = Object.values(hearingData).filter(h => h.date && !h.isPast).length;
            const hasHearingDataLoaded = Object.keys(hearingData).length > 0;

            // ─────────────────────────────────────────────────────────────────────────

            const refreshData = async () => {
                if (!selectedPeriod) return;
                setLoading(true);
                setError(null);
                try {
                    const allResults = [];
                    const delay = ms => new Promise(r => setTimeout(r, ms));

                    if ((searchMode === 'all' || searchMode === 'keywords') && trackedKeywords.length > 0) {
                        for (const keyword of trackedKeywords) {
                            try {
                                const result = await proxyFetch('/SearchLegislation', 'POST', {
                                    Keyword: keyword, CategoryId: 0,
                                    CouncilPeriodId: selectedPeriod.councilPeriodId, RowLimit: 20, OffSet: 0
                                });
                                allResults.push(Array.isArray(result) ? result : []);
                            } catch (err) { console.error(`Error searching for "${keyword}":`, err); allResults.push([]); }
                            await delay(1000);
                        }
                    }
                    if ((searchMode === 'all' || searchMode === 'committees') && trackedCommittees.length > 0) {
                        for (const committee of trackedCommittees) {
                            try {
                                const results = await proxyFetch('/SearchLegislation', 'POST', {
                                    Keyword: committee, CategoryId: 0,
                                    CouncilPeriodId: selectedPeriod.councilPeriodId, RowLimit: 50, OffSet: 0
                                });
                                allResults.push(Array.isArray(results) ? results.filter(leg => {
                                    const cs = leg.referredToCommittees;
                                    return cs && cs !== 'null' && cs.toLowerCase().includes(committee.toLowerCase());
                                }) : []);
                            } catch (err) { console.error(`Error searching committee "${committee}":`, err); allResults.push([]); }
                            await delay(1000);
                        }
                    }
                    if ((searchMode === 'all' || searchMode === 'sponsors') && trackedSponsors.length > 0) {
                        trackedSponsors.forEach(() => allResults.push([]));
                    }

                    const results = allResults;
                    const allLegislation = [];
                    const seenIds = new Set();
                    results.forEach(result => {
                        (Array.isArray(result) ? result : []).forEach(leg => {
                            if (leg && leg.legislationNumber && !seenIds.has(leg.legislationNumber)) {
                                seenIds.add(leg.legislationNumber);
                                allLegislation.push(leg);
                            }
                        });
                    });

                    const transformedItems = allLegislation.map(leg => {
                        const cs = leg.referredToCommittees;
                        const committees = (cs && cs !== 'null' && typeof cs === 'string' && cs.trim()) ? [cs] : [];
                        const introducedBy = leg.introducedBy || leg.primarySponsor || leg.introducers || leg.sponsor || null;
                        return {
                            id: leg.legislationNumber, title: leg.title, billNumber: leg.legislationNumber,
                            category: leg.category || leg.subCategory || 'Uncategorized',
                            status: leg.status || 'Unknown', committees,
                            date: leg.introductionDate ? new Date(leg.introductionDate).toISOString().split('T')[0] : '',
                            description: leg.shortDescription || leg.title,
                            link: `https://lims.dccouncil.gov/Legislation/${leg.legislationNumber}`,
                            source: 'DC Council', isNew: isNewItem(leg.introductionDate),
                            assignedTo: null, priority: null, actionStatus: 'action_needed', introducedBy
                        };
                    });

                    const existingTrackedItems = items.filter(item =>
                        selectedItems.has(item.id) && !allLegislation.some(leg => leg.legislationNumber === item.id)
                    );
                    const mergedItems = transformedItems.map(item => {
                        if (selectedItems.has(item.id)) {
                            const existing = items.find(i => i.id === item.id);
                            if (existing) {
                                let hasNewActivity = false, activitySummary = null;
                                if (existing.lastStatus && existing.status !== item.status) {
                                    hasNewActivity = true;
                                    activitySummary = `Status changed from "${existing.lastStatus}" to "${item.status}"`;
                                }
                                if (hasNewActivity) updateItemActivity(item.id, item.status, activitySummary);
                                return { ...item, assignedTo: existing.assignedTo, priority: existing.priority,
                                    actionStatus: existing.actionStatus, hasNewActivity, activitySummary,
                                    lastStatus: item.status, lastCheckedAt: new Date().toISOString() };
                            }
                        }
                        return item;
                    });
                    setItems([...existingTrackedItems, ...mergedItems]);
                    setLoading(false);
                } catch (err) {
                    console.error('Error in refreshData:', err);
                    setError('Failed to fetch legislation: ' + err.message);
                    setLoading(false);
                }
            };

            const isNewItem = (dateString) => {
                if (!dateString) return false;
                return (new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24) <= 7;
            };

            const quickSearchByCategory = async (categoryName, offset = 0, append = false) => {
                if (!selectedPeriod) return;
                setLoading(true);
                setError(null);
                if (!append) {
                    setSearchOffset(0);
                    setCurrentSearchCategory(categoryName);
                    setFilters({...filters, category: categoryName, keywords: ''});
                    setSearchMode('keywords');
                }
                try {
                    const results = await proxyFetch('/SearchLegislation', 'POST', {
                        Keyword: '', CategoryId: 0,
                        CouncilPeriodId: selectedPeriod.councilPeriodId, RowLimit: 100, OffSet: offset
                    });
                    setHasMoreResults(results && results.length === 100);
                    const allLegislation = [];
                    const seenIds = new Set();
                    (Array.isArray(results) ? results : []).forEach(leg => {
                        if (leg && leg.legislationNumber && !seenIds.has(leg.legislationNumber)) {
                            seenIds.add(leg.legislationNumber);
                            allLegislation.push(leg);
                        }
                    });
                    const transformedItems = allLegislation.map(leg => {
                        const cs = leg.referredToCommittees;
                        const committees = (cs && cs !== 'null' && typeof cs === 'string' && cs.trim()) ? [cs] : [];
                        const introducedBy = leg.introducedBy || leg.primarySponsor || leg.introducers || leg.sponsor || null;
                        return {
                            id: leg.legislationNumber, title: leg.title, billNumber: leg.legislationNumber,
                            category: leg.category || leg.subCategory || 'Uncategorized',
                            status: leg.status || 'Unknown', committees,
                            date: leg.introductionDate ? new Date(leg.introductionDate).toISOString().split('T')[0] : '',
                            description: leg.shortDescription || leg.title,
                            link: `https://lims.dccouncil.gov/Legislation/${leg.legislationNumber}`,
                            source: 'DC Council', isNew: isNewItem(leg.introductionDate),
                            assignedTo: null, priority: null, actionStatus: 'action_needed', introducedBy
                        };
                    });
                    const filteredByCategory = categoryName !== 'all'
                        ? transformedItems.filter(item => item.category === categoryName)
                        : transformedItems;
                    if (append) {
                        const existingIds = new Set(items.map(i => i.id));
                        setItems([...items, ...filteredByCategory.filter(item => !existingIds.has(item.id))]);
                    } else {
                        const existingTrackedItems = items.filter(item =>
                            selectedItems.has(item.id) && !allLegislation.some(leg => leg.legislationNumber === item.id)
                        );
                        const mergedItems = filteredByCategory.map(item => {
                            if (selectedItems.has(item.id)) {
                                const existing = items.find(i => i.id === item.id);
                                if (existing) return { ...item, assignedTo: existing.assignedTo, priority: existing.priority, actionStatus: existing.actionStatus };
                            }
                            return item;
                        });
                        setItems([...existingTrackedItems, ...mergedItems]);
                    }
                    setLoading(false);
                } catch (err) {
                    setError('Failed to search: ' + err.message);
                    setLoading(false);
                }
            };

            const loadMoreResults = () => {
                const newOffset = searchOffset + 100;
                setSearchOffset(newOffset);
                quickSearchByCategory(currentSearchCategory, newOffset, true);
            };

            const toggleSelection = async (itemId) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                const isCurrentlySelected = selectedItems.has(itemId);
                try {
                    if (isCurrentlySelected) {
                        const { error } = await supabase.from('tracked_items').delete().eq('id', itemId);
                        if (error) throw error;
                        const newSelected = new Set(selectedItems);
                        newSelected.delete(itemId);
                        setSelectedItems(newSelected);
                        await logActivity('item_untracked', itemId, item.title);
                    } else {
                        const { error } = await supabase.from('tracked_items').insert({
                            id: item.id, title: item.title, bill_number: item.billNumber,
                            category: item.category, status: item.status, committees: item.committees,
                            date: item.date, description: item.description, link: item.link,
                            source: item.source, agency: item.agency,
                            is_manual_entry: item.source === 'Municipal Register',
                            is_new: item.isNew, assigned_to: 'Unassigned', priority: 'medium',
                            action_status: 'action_needed', introduced_by: item.introducedBy,
                            last_status: item.status, last_checked_at: new Date().toISOString(), has_new_activity: false
                        });
                        if (error) throw error;
                        const newSelected = new Set(selectedItems);
                        newSelected.add(itemId);
                        setSelectedItems(newSelected);
                        setItems(items.map(i => i.id === itemId ? { ...i, assignedTo: 'Unassigned', priority: 'medium', actionStatus: 'action_needed' } : i));
                        await logActivity('item_tracked', itemId, item.title, { source: item.source, category: item.category });
                    }
                } catch (err) {
                    console.error('Error toggling selection:', err);
                    setError('Failed to update tracking: ' + err.message);
                }
            };

            const updateAssignment = async (itemId, newAssignee) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                try {
                    const { error } = await supabase.from('tracked_items').update({ assigned_to: newAssignee }).eq('id', itemId);
                    if (error) throw error;
                    setItems(items.map(i => i.id === itemId ? { ...i, assignedTo: newAssignee } : i));
                    await logActivity('assigned', itemId, item.title, { from: item.assignedTo, to: newAssignee });
                } catch (err) { setError('Failed to update assignment: ' + err.message); }
            };

            const updatePriority = async (itemId, newPriority) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                try {
                    const { error } = await supabase.from('tracked_items').update({ priority: newPriority }).eq('id', itemId);
                    if (error) throw error;
                    setItems(items.map(i => i.id === itemId ? { ...i, priority: newPriority } : i));
                    await logActivity('priority_changed', itemId, item.title, { from: item.priority, to: newPriority });
                } catch (err) { setError('Failed to update priority: ' + err.message); }
            };

            const updateActionStatus = async (itemId, newStatus) => {
                const item = items.find(i => i.id === itemId);
                if (!item) return;
                try {
                    const { error } = await supabase.from('tracked_items').update({ action_status: newStatus }).eq('id', itemId);
                    if (error) throw error;
                    setItems(items.map(i => i.id === itemId ? { ...i, actionStatus: newStatus } : i));
                    await logActivity('action_status_changed', itemId, item.title, { from: item.actionStatus, to: newStatus });
                } catch (err) { setError('Failed to update action status: ' + err.message); }
            };

            const updateItemActivity = async (itemId, newStatus, activitySummary) => {
                try {
                    const { error } = await supabase.from('tracked_items').update({
                        last_status: newStatus, has_new_activity: true,
                        activity_summary: activitySummary, last_checked_at: new Date().toISOString()
                    }).eq('id', itemId);
                    if (error) throw error;
                    await logActivity('activity_detected', itemId, null, { summary: activitySummary });
                } catch (err) { console.error('Error updating item activity:', err); }
            };

            const markActivityAsSeen = async (itemId) => {
                try {
                    const { error } = await supabase.from('tracked_items')
                        .update({ has_new_activity: false, activity_summary: null }).eq('id', itemId);
                    if (error) throw error;
                    setItems(items.map(i => i.id === itemId ? { ...i, hasNewActivity: false, activitySummary: null } : i));
                } catch (err) { setError('Failed to mark activity as seen: ' + err.message); }
            };

            const saveNote = async () => {
                if (!editingNote) return;
                const item = items.find(i => i.id === editingNote);
                try {
                    const { error } = await supabase.from('item_notes').upsert({ item_id: editingNote, note_text: noteText });
                    if (error) throw error;
                    setItemNotes({...itemNotes, [editingNote]: noteText});
                    await logActivity(itemNotes[editingNote] ? 'note_updated' : 'note_added', editingNote, item?.title || 'Unknown');
                    setEditingNote(null);
                    setNoteText('');
                } catch (err) { setError('Failed to save note: ' + err.message); }
            };

            const deleteNote = async (itemId) => {
                const item = items.find(i => i.id === itemId);
                try {
                    const { error } = await supabase.from('item_notes').delete().eq('item_id', itemId);
                    if (error) throw error;
                    const newNotes = {...itemNotes};
                    delete newNotes[itemId];
                    setItemNotes(newNotes);
                    await logActivity('note_deleted', itemId, item?.title || 'Unknown');
                } catch (err) { setError('Failed to delete note: ' + err.message); }
            };

            const saveSummary = async () => {
                if (!editingSummary) return;
                const item = items.find(i => i.id === editingSummary);
                try {
                    const { error } = await supabase.from('tracked_items').update({ manual_summary: summaryText || null }).eq('id', editingSummary);
                    if (error) throw error;
                    setItems(prev => prev.map(i => i.id === editingSummary ? { ...i, manualSummary: summaryText || null } : i));
                    setEditingSummary(null);
                    setSummaryText('');
                } catch (err) { setError('Failed to save summary: ' + err.message); }
            };

            const deleteManualSummary = async (itemId) => {
                try {
                    const { error } = await supabase.from('tracked_items').update({ manual_summary: null }).eq('id', itemId);
                    if (error) throw error;
                    setItems(prev => prev.map(i => i.id === itemId ? { ...i, manualSummary: null } : i));
                } catch (err) { setError('Failed to delete summary: ' + err.message); }
            };

            const addKeyword = async () => {
                if (!newKeyword.trim()) return;
                const incoming = newKeyword.split(',').map(k => k.trim().toLowerCase()).filter(k => k && !trackedKeywords.includes(k));
                if (!incoming.length) { setNewKeyword(''); setShowAddKeyword(false); return; }
                try {
                    const { error } = await supabase.from('tracked_keywords').insert(incoming.map(k => ({ keyword: k })));
                    if (error) throw error;
                    setTrackedKeywords([...trackedKeywords, ...incoming]);
                    setNewKeyword(''); setShowAddKeyword(false);
                    await logActivity('keyword_added', null, null, { keywords: incoming.join(', ') });
                } catch (err) { setError('Failed to add keywords: ' + err.message); }
            };

            const removeKeyword = async (keyword) => {
                try {
                    const { error } = await supabase.from('tracked_keywords').delete().eq('keyword', keyword);
                    if (error) throw error;
                    setTrackedKeywords(trackedKeywords.filter(k => k !== keyword));
                    await logActivity('keyword_removed', null, null, { keyword });
                } catch (err) { setError('Failed to remove keyword: ' + err.message); }
            };

            const addCommittee = async () => {
                if (!newCommittee.trim() || trackedCommittees.includes(newCommittee)) return;
                try {
                    const { error } = await supabase.from('tracked_committees').insert({ committee_name: newCommittee });
                    if (error) throw error;
                    setTrackedCommittees([...trackedCommittees, newCommittee]);
                    setNewCommittee(''); setShowAddCommittee(false);
                    await logActivity('committee_added', null, null, { committee: newCommittee });
                } catch (err) { setError('Failed to add committee: ' + err.message); }
            };

            const removeCommittee = async (committee) => {
                try {
                    const { error } = await supabase.from('tracked_committees').delete().eq('committee_name', committee);
                    if (error) throw error;
                    setTrackedCommittees(trackedCommittees.filter(c => c !== committee));
                    await logActivity('committee_removed', null, null, { committee });
                } catch (err) { setError('Failed to remove committee: ' + err.message); }
            };

            const addSponsor = async () => {
                if (!newSponsor.trim() || trackedSponsors.includes(newSponsor)) return;
                try {
                    const { error } = await supabase.from('tracked_sponsors').insert({ sponsor_name: newSponsor });
                    if (error) throw error;
                    setTrackedSponsors([...trackedSponsors, newSponsor]);
                    setNewSponsor(''); setShowAddSponsor(false);
                    await logActivity('sponsor_added', null, null, { sponsor: newSponsor });
                } catch (err) { setError('Failed to add sponsor: ' + err.message); }
            };

            const removeSponsor = async (sponsor) => {
                try {
                    const { error } = await supabase.from('tracked_sponsors').delete().eq('sponsor_name', sponsor);
                    if (error) throw error;
                    setTrackedSponsors(trackedSponsors.filter(s => s !== sponsor));
                    await logActivity('sponsor_removed', null, null, { sponsor });
                } catch (err) { setError('Failed to remove sponsor: ' + err.message); }
            };

            const addManualEntry = async () => {
                if (!manualEntry.title.trim()) { alert('Please enter a title'); return; }
                const blankManual = { title: '', agency: '', status: 'Published', date: new Date().toISOString().split('T')[0], link: '', assignedTo: 'Unassigned', priority: 'medium', actionStatus: 'action_needed', noticeId: '', registerIssue: '', registerNotes: '', deadline: '' };
                const newItem = {
                    id: `MANUAL-${Date.now()}`, title: manualEntry.title, billNumber: null,
                    agency: manualEntry.agency || 'DC Government', category: 'Municipal Regulation',
                    status: manualEntry.status, date: manualEntry.date, description: manualEntry.title,
                    link: manualEntry.link, source: 'Municipal Register', isNew: isNewItem(manualEntry.date),
                    committees: [], assignedTo: manualEntry.assignedTo, priority: manualEntry.priority,
                    actionStatus: manualEntry.actionStatus, introducedBy: null,
                    noticeId: manualEntry.noticeId, registerIssue: manualEntry.registerIssue,
                    registerNotes: manualEntry.registerNotes, isManualEntry: true,
                    deadline: manualEntry.deadline || null,
                    additionalInformation: null, committeeReReferral: [], activityCount: 0,
                    latestActivityDate: manualEntry.deadline || manualEntry.date || null
                };
                try {
                    const { error } = await supabase.from('tracked_items').insert({
                        id: newItem.id, title: newItem.title, bill_number: null,
                        category: newItem.category, status: newItem.status, committees: [],
                        date: newItem.date, description: newItem.description, link: newItem.link,
                        source: newItem.source, agency: newItem.agency, is_manual_entry: true,
                        is_new: newItem.isNew, assigned_to: newItem.assignedTo, priority: newItem.priority,
                        action_status: newItem.actionStatus, introduced_by: null,
                        notice_id: newItem.noticeId, register_issue: newItem.registerIssue,
                        register_notes: newItem.registerNotes,
                        deadline: newItem.deadline || null,
                        latest_activity_date: newItem.latestActivityDate
                    });
                    if (error) throw error;
                    setItems([newItem, ...items]);
                    const newSelected = new Set(selectedItems);
                    newSelected.add(newItem.id);
                    setSelectedItems(newSelected);
                    await logActivity('manual_entry_added', newItem.id, newItem.title, { source: 'Municipal Register' });
                    setShowManualEntry(false);
                    setManualEntry(blankManual);
                } catch (err) { setError('Failed to add manual entry: ' + err.message); }
            };

            const editManualEntry = (item) => {
                setEditingManualEntry(item.id);
                setManualEntry({ title: item.title, agency: item.agency || '', status: item.status,
                    date: item.date, link: item.link || '', assignedTo: item.assignedTo, priority: item.priority,
                    actionStatus: item.actionStatus, noticeId: item.noticeId || '',
                    registerIssue: item.registerIssue || '', registerNotes: item.registerNotes || '',
                    deadline: item.deadline || '' });
                setShowManualEntry(true);
            };

            const updateManualEntry = async () => {
                if (!manualEntry.title.trim()) { alert('Please enter a title'); return; }
                const blankManual = { title: '', agency: '', status: 'Published', date: new Date().toISOString().split('T')[0], link: '', assignedTo: 'Unassigned', priority: 'medium', actionStatus: 'action_needed', noticeId: '', registerIssue: '', registerNotes: '', deadline: '' };
                try {
                    const { error } = await supabase.from('tracked_items').update({
                        title: manualEntry.title, agency: manualEntry.agency, status: manualEntry.status,
                        date: manualEntry.date, link: manualEntry.link, assigned_to: manualEntry.assignedTo,
                        priority: manualEntry.priority, action_status: manualEntry.actionStatus,
                        notice_id: manualEntry.noticeId, register_issue: manualEntry.registerIssue,
                        register_notes: manualEntry.registerNotes, description: manualEntry.title,
                        deadline: manualEntry.deadline || null,
                        latest_activity_date: manualEntry.deadline || manualEntry.date || null
                    }).eq('id', editingManualEntry);
                    if (error) throw error;
                    setItems(items.map(item => item.id === editingManualEntry
                        ? { ...item, title: manualEntry.title, agency: manualEntry.agency, status: manualEntry.status,
                            date: manualEntry.date, link: manualEntry.link, assignedTo: manualEntry.assignedTo,
                            priority: manualEntry.priority, actionStatus: manualEntry.actionStatus,
                            noticeId: manualEntry.noticeId, registerIssue: manualEntry.registerIssue,
                            registerNotes: manualEntry.registerNotes, description: manualEntry.title,
                            deadline: manualEntry.deadline || null,
                            latestActivityDate: manualEntry.deadline || manualEntry.date || null }
                        : item
                    ));
                    await logActivity('manual_entry_updated', editingManualEntry, manualEntry.title);
                    setShowManualEntry(false);
                    setEditingManualEntry(null);
                    setManualEntry(blankManual);
                } catch (err) { setError('Failed to update manual entry: ' + err.message); }
            };

            const deleteManualEntry = async (itemId) => {
                if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) return;
                try {
                    const { error } = await supabase.from('tracked_items').delete().eq('id', itemId);
                    if (error) throw error;
                    setItems(items.filter(item => item.id !== itemId));
                    const newSelected = new Set(selectedItems);
                    newSelected.delete(itemId);
                    setSelectedItems(newSelected);
                    await logActivity('manual_entry_deleted', itemId, null);
                } catch (err) { setError('Failed to delete manual entry: ' + err.message); }
            };

            const addTeamMember = async () => {
                if (!teamMemberForm.name.trim()) { alert('Please enter a name'); return; }
                try {
                    const { error } = await supabase.from('team_members')
                        .insert({ name: teamMemberForm.name, email: teamMemberForm.email || null, active: true });
                    if (error) throw error;
                    const { data: membersData } = await supabase.from('team_members').select('*').eq('active', true).order('name', { ascending: true });
                    if (membersData) setTeamMembers(membersData);
                    setTeamMemberForm({ name: '', email: '' });
                    await logActivity('team_member_added', null, null, { name: teamMemberForm.name });
                } catch (err) { setError('Failed to add team member: ' + err.message); }
            };

            const editTeamMember = (member) => {
                setEditingTeamMember(member.id);
                setTeamMemberForm({ name: member.name, email: member.email || '' });
            };

            const updateTeamMember = async () => {
                if (!teamMemberForm.name.trim()) { alert('Please enter a name'); return; }
                try {
                    const oldMember = teamMembers.find(m => m.id === editingTeamMember);
                    const { error } = await supabase.from('team_members')
                        .update({ name: teamMemberForm.name, email: teamMemberForm.email || null }).eq('id', editingTeamMember);
                    if (error) throw error;
                    if (oldMember && oldMember.name !== teamMemberForm.name) {
                        await supabase.from('tracked_items').update({ assigned_to: teamMemberForm.name }).eq('assigned_to', oldMember.name);
                        setItems(items.map(item => item.assignedTo === oldMember.name ? { ...item, assignedTo: teamMemberForm.name } : item));
                    }
                    const { data: membersData } = await supabase.from('team_members').select('*').eq('active', true).order('name', { ascending: true });
                    if (membersData) setTeamMembers(membersData);
                    setEditingTeamMember(null);
                    setTeamMemberForm({ name: '', email: '' });
                    await logActivity('team_member_updated', null, null, { from: oldMember?.name, to: teamMemberForm.name });
                } catch (err) { setError('Failed to update team member: ' + err.message); }
            };

            const deleteTeamMember = async (memberId) => {
                const member = teamMembers.find(m => m.id === memberId);
                if (!confirm(`Are you sure you want to delete ${member?.name}?`)) return;
                try {
                    const { error } = await supabase.from('team_members').update({ active: false }).eq('id', memberId);
                    if (error) throw error;
                    const { data: membersData } = await supabase.from('team_members').select('*').eq('active', true).order('name', { ascending: true });
                    if (membersData) setTeamMembers(membersData);
                    await logActivity('team_member_deleted', null, null, { name: member?.name });
                } catch (err) { setError('Failed to delete team member: ' + err.message); }
            };

            const generateEmailBody = () => {
                const reportItems = filteredItems.filter(item =>
                    selectedItems.has(item.id) &&
                    (item.actionStatus === 'action_needed' || item.actionStatus === 'monitor_and_assess')
                );
                const actionNeeded = reportItems.filter(item => item.actionStatus === 'action_needed');
                const monitorAndAssess = reportItems.filter(item => item.actionStatus === 'monitor_and_assess');
                const hearingItems = items
                    .filter(item => selectedItems.has(item.id) && hearingData[item.id]?.date && !hearingData[item.id]?.isPast)
                    .sort((a, b) => hearingData[a.id].date - hearingData[b.id].date);

                let emailBody = `DC Policy Tracker - Status Update\nGenerated: ${new Date().toLocaleDateString()}\n\n`;
                emailBody += `=================================================\n\n`;

                if (hearingItems.length > 0) {
                    emailBody += `UPCOMING HEARINGS (${hearingItems.length} items)\n=================================================\n\n`;
                    hearingItems.forEach((item, idx) => {
                        const h = hearingData[item.id];
                        emailBody += `${idx + 1}. ${item.title}\n`;
                        emailBody += `   Bill: ${item.billNumber || 'N/A'} | Hearing: ${h.dateStr}${h.timeStr ? ' at ' + h.timeStr : ''}${h.location ? ' — ' + h.location : ''}\n`;
                        emailBody += `   Link: ${item.link}\n\n`;
                    });
                }

                if (actionNeeded.length > 0) {
                    emailBody += `ACTION NEEDED (${actionNeeded.length} items)\n=================================================\n\n`;
                    actionNeeded.forEach((item, idx) => {
                        emailBody += `${idx + 1}. ${item.title}\n`;
                        emailBody += `   Bill Number: ${item.billNumber || 'N/A'}\n   Category: ${item.category}\n   Status: ${item.status}\n`;
                        emailBody += `   Assigned To: ${item.assignedTo || 'Unassigned'}\n   Priority: ${item.priority || 'N/A'}\n`;
                        if (item.introducedBy) emailBody += `   Introduced By: ${item.introducedBy}\n`;
                        if (item.latestActivityDate && item.latestActivityLabel) emailBody += `   Latest Activity: ${item.latestActivityLabel} (${new Date(item.latestActivityDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })})\n`;
                        if (hearingData[item.id]?.date && !hearingData[item.id]?.isPast) emailBody += `   Hearing: ${hearingData[item.id].dateStr}\n`;
                        const summary1 = item.manualSummary || item.additionalInformation;
                        if (summary1) emailBody += `   Summary: ${summary1.substring(0, 300)}${summary1.length > 300 ? '...' : ''}\n`;
                        if (itemNotes[item.id]) emailBody += `   Notes: ${itemNotes[item.id]}\n`;
                        emailBody += `   Link: ${item.link}\n\n`;
                    });
                }

                if (monitorAndAssess.length > 0) {
                    emailBody += `\nMONITOR AND ASSESS (${monitorAndAssess.length} items)\n=================================================\n\n`;
                    monitorAndAssess.forEach((item, idx) => {
                        emailBody += `${idx + 1}. ${item.title}\n`;
                        emailBody += `   Bill Number: ${item.billNumber || 'N/A'}\n   Category: ${item.category}\n   Status: ${item.status}\n`;
                        emailBody += `   Assigned To: ${item.assignedTo || 'Unassigned'}\n   Priority: ${item.priority || 'N/A'}\n`;
                        if (item.introducedBy) emailBody += `   Introduced By: ${item.introducedBy}\n`;
                        if (item.latestActivityDate && item.latestActivityLabel) emailBody += `   Latest Activity: ${item.latestActivityLabel} (${new Date(item.latestActivityDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })})\n`;
                        if (hearingData[item.id]?.date && !hearingData[item.id]?.isPast) emailBody += `   Hearing: ${hearingData[item.id].dateStr}\n`;
                        const summary2 = item.manualSummary || item.additionalInformation;
                        if (summary2) emailBody += `   Summary: ${summary2.substring(0, 300)}${summary2.length > 300 ? '...' : ''}\n`;
                        if (itemNotes[item.id]) emailBody += `   Notes: ${itemNotes[item.id]}\n`;
                        emailBody += `   Link: ${item.link}\n\n`;
                    });
                }

                if (reportItems.length === 0 && hearingItems.length === 0) {
                    emailBody += `No items with "Action Needed" or "Monitor and Assess" status.\n`;
                }
                return emailBody;
            };

            const copyEmailToClipboard = () => {
                navigator.clipboard.writeText(generateEmailBody())
                    .then(() => alert('Email content copied to clipboard!'))
                    .catch(() => alert('Failed to copy to clipboard'));
            };

            const exportToCSV = () => {
                const headers = ['Title', 'Bill Number', 'Category', 'Status', 'Next Hearing', 'Hearing Location', 'Committees', 'Date', 'Assigned To', 'Priority', 'Action Status', 'Introduced By', 'Link', 'Notes', 'Tracked'];
                const rows = filteredItems.map(item => {
                    const h = hearingData[item.id];
                    return [
                        item.title, item.billNumber || '', item.category, item.status,
                        h?.dateStr || '', h?.location || '',
                        item.committees ? item.committees.join('; ') : '',
                        item.date, item.assignedTo || '', item.priority || '',
                        item.actionStatus || '', item.introducedBy || '',
                        item.link || '', itemNotes[item.id] || '',
                        selectedItems.has(item.id) ? 'Yes' : 'No'
                    ];
                });
                const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dc-policy-tracker-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            const filteredItems = items.filter(item => {
                const matchesKeyword = !filters.keywords ||
                    item.title.toLowerCase().includes(filters.keywords.toLowerCase()) ||
                    item.description.toLowerCase().includes(filters.keywords.toLowerCase());
                const matchesCommittee = filters.committee === 'all' ||
                    (item.committees && item.committees.some(c => c === filters.committee));
                const matchesCategory = filters.category === 'all' || item.category === filters.category;
                const matchesAssignedTo = filters.assignedTo === 'all' || item.assignedTo === filters.assignedTo;
                const matchesPriority = filters.priority === 'all' || item.priority === filters.priority;
                const matchesActionStatus = filters.actionStatus === 'all' ||
                    (selectedItems.has(item.id) && item.actionStatus === filters.actionStatus);
                const matchesIntroducedBy = filters.introducedBy === 'all' || item.introducedBy === filters.introducedBy;
                const matchesHideTracked = !filters.hideTrackedItems || !selectedItems.has(item.id);
                const matchesUpcomingHearing = !filters.hasUpcomingHearing || (() => {
                    const h = hearingData[item.id];
                    if (h && h.date && !h.isPast) return true;
                    if (!item.isManualEntry && item.status && (
                        item.status.toLowerCase().includes('hearing') ||
                        item.status.toLowerCase().includes('scheduled') ||
                        item.status.toLowerCase().includes('notice') ||
                        item.status.toLowerCase().includes('markup')
                    )) return true;
                    return false;
                })();
                const matchesActivityFilter = (() => {
                    if (activityFilter === 'all') return true;
                    const days = parseInt(activityFilter);
                    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
                    const actDate = item.latestActivityDate ? new Date(item.latestActivityDate) : null;
                    const addedDate = item.isManualEntry && item.trackedAt ? new Date(item.trackedAt) : null;
                    return (actDate && actDate >= cutoff) || (addedDate && addedDate >= cutoff);
                })();
                return matchesKeyword && matchesCommittee && matchesCategory && matchesAssignedTo &&
                    matchesPriority && matchesActionStatus && matchesIntroducedBy &&
                    matchesHideTracked && matchesUpcomingHearing && matchesActivityFilter;
            }).sort((a, b) => {
                if (!sortByActivity) return 0; // preserve default order
                const dateA = a.latestActivityDate ? new Date(a.latestActivityDate) : new Date(a.date || 0);
                const dateB = b.latestActivityDate ? new Date(b.latestActivityDate) : new Date(b.date || 0);
                return dateB - dateA;
            });

            const categories = ['all', ...new Set(items.map(i => i.category).filter(Boolean))];
            const committees = ['all', ...new Set(items.filter(i => i.committees && i.committees.length > 0).flatMap(i => i.committees).filter(Boolean))];
            const assignees = ['all', ...new Set(items.map(i => i.assignedTo).filter(Boolean))];
            const priorities = ['all', 'high', 'medium', 'low'];
            const actionStatuses = ['all', 'action_needed', 'action_completed', 'monitor_and_assess'];
            const introducers = ['all', ...new Set(items.map(i => i.introducedBy).filter(Boolean))];

            const getPriorityColor = (p) => ({ high: 'bg-red-100 text-red-700', medium: 'bg-yellow-100 text-yellow-700', low: 'bg-green-100 text-green-700' }[p] || 'bg-gray-100 text-gray-700');
            const getActionStatusColor = (s) => ({ action_needed: 'bg-red-100 text-red-700', action_completed: 'bg-green-100 text-green-700', monitor_and_assess: 'bg-blue-100 text-blue-700' }[s] || 'bg-gray-100 text-gray-700');
            const getActionStatusLabel = (s) => ({ action_needed: 'ACTION NEEDED', action_completed: 'ACTION COMPLETED', monitor_and_assess: 'MONITOR & ASSESS' }[s] || s);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">DC Policy Tracker</h1>
                                    <p className="text-gray-600">Legislative Monitoring System</p>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    <button onClick={() => setShowTeamManagement(true)} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">👥 Manage Team</button>
                                    <button
                                        onClick={checkHearingsForTrackedItems}
                                        disabled={checkingHearings || selectedItems.size === 0}
                                        className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:bg-gray-400 font-medium"
                                        title={selectedItems.size === 0 ? 'Track some items first' : 'Check hearing dates for all tracked bills'}
                                    >
                                        {checkingHearings
                                            ? `⏳ Checking… ${hearingCheckProgress.done}/${hearingCheckProgress.total}`
                                            : upcomingHearingCount > 0
                                                ? `📅 Hearings (${upcomingHearingCount})`
                                                : '📅 Check Hearings'}
                                    </button>
                                    {hasHearingDataLoaded && (
                                        <button onClick={() => setShowHearingPanel(true)} className="px-4 py-2 bg-amber-100 text-amber-800 border border-amber-300 rounded-lg hover:bg-amber-200 font-medium">
                                            📋 Hearing Report
                                        </button>
                                    )}
                                    <button onClick={() => setShowEmailPreview(true)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">📧 Generate Email</button>
                                    <button onClick={() => { setShowActivityLog(true); loadActivityLog(); }} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">📋 Activity Log</button>
                                    <button onClick={() => setShowManualEntry(true)} className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">+ Add DC Register</button>
                                    <button onClick={exportToCSV} className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                                    <button onClick={refreshData} disabled={loading} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">{loading ? 'Loading...' : 'Refresh'}</button>
                                </div>
                            </div>

                            {checkingHearings && (
                                <div className="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-medium text-amber-800">Fetching hearing details from DC Council API…</span>
                                        <span className="text-sm text-amber-700">{hearingCheckProgress.done} / {hearingCheckProgress.total}</span>
                                    </div>
                                    <div className="w-full bg-amber-200 rounded-full h-2">
                                        <div className="bg-amber-500 h-2 rounded-full transition-all duration-300"
                                            style={{ width: `${hearingCheckProgress.total > 0 ? (hearingCheckProgress.done / hearingCheckProgress.total) * 100 : 0}%` }} />
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 mb-4 flex justify-between items-center">
                                    <span>{error}</span>
                                    <button onClick={() => setError(null)} className="text-red-700 hover:text-red-900">×</button>
                                </div>
                            )}

                            {selectedPeriod && (
                                <div className="mb-4">
                                    <div className="text-sm text-gray-600 flex items-center justify-between mb-3">
                                        <div>
                                            Council Period: <strong>{selectedPeriod.councilPeriod}</strong>
                                            {selectedItems.size > 0 && <span className="ml-2 px-2 py-1 bg-indigo-100 text-indigo-700 rounded">{selectedItems.size} items tracked</span>}
                                            {upcomingHearingCount > 0 && (
                                                <button onClick={() => setShowHearingPanel(true)} className="ml-2 px-2 py-1 bg-amber-500 text-white rounded text-xs font-bold hover:bg-amber-600">
                                                    📅 {upcomingHearingCount} upcoming hearing{upcomingHearingCount !== 1 ? 's' : ''}
                                                </button>
                                            )}
                                            {items.filter(i => i.hasNewActivity && selectedItems.has(i.id)).length > 0 && (
                                                <span className="ml-2 px-2 py-1 bg-orange-500 text-white rounded animate-pulse">
                                                    🔔 {items.filter(i => i.hasNewActivity && selectedItems.has(i.id)).length} with new activity
                                                </span>
                                            )}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => setFilters({...filters, actionStatus: 'action_needed'})} className="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">Show Action Needed</button>
                                            <button onClick={() => setFilters({...filters, actionStatus: 'monitor_and_assess'})} className="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Show Monitor & Assess</button>
                                            <button onClick={() => setFilters({...filters, actionStatus: 'action_completed'})} className="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">Show Completed</button>
                                            <button onClick={() => setFilters({...filters, actionStatus: 'all'})} className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Show All</button>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 flex-wrap">
                                        <div className="text-sm font-semibold text-gray-700">Quick Search:</div>
                                        <button onClick={() => quickSearchByCategory('Bill')} disabled={loading} className="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 font-medium disabled:opacity-50">Latest Bills</button>
                                        <button onClick={() => quickSearchByCategory('Resolution')} disabled={loading} className="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 font-medium disabled:opacity-50">Latest Resolutions</button>
                                        <button onClick={() => quickSearchByCategory('Act')} disabled={loading} className="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 font-medium disabled:opacity-50">Latest Acts</button>
                                        <button onClick={() => quickSearchByCategory('all')} disabled={loading} className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-medium disabled:opacity-50">All Legislation</button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">Search Mode</h2>
                                    <div className="space-y-2">
                                        {[['all','Search All (Keywords + Committees + Sponsors)'],['keywords','Keywords Only'],['committees','Committees Only'],['sponsors','Sponsors Only']].map(([val, label]) => (
                                            <label key={val} className="flex items-center">
                                                <input type="radio" name="searchMode" value={val} checked={searchMode === val} onChange={e => setSearchMode(e.target.value)} className="mr-2" />
                                                <span className="text-sm">{label}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Keywords</h2>
                                        <button onClick={() => setShowAddKeyword(true)} className="text-indigo-600 hover:text-indigo-800">+ Add</button>
                                    </div>
                                    <div className="space-y-2">
                                        {trackedKeywords.map(keyword => (
                                            <div key={keyword} className="flex items-center justify-between p-2 bg-indigo-50 rounded">
                                                <span className="capitalize">{keyword}</span>
                                                <button onClick={() => removeKeyword(keyword)} className="text-red-600 hover:text-red-800">×</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Committees</h2>
                                        <button onClick={() => setShowAddCommittee(true)} className="text-indigo-600 hover:text-indigo-800">+ Add</button>
                                    </div>
                                    <div className="space-y-2">
                                        {trackedCommittees.map(committee => (
                                            <div key={committee} className="flex items-center justify-between p-2 bg-blue-50 rounded">
                                                <span className="text-sm">{committee}</span>
                                                <button onClick={() => removeCommittee(committee)} className="text-red-600 hover:text-red-800">×</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Tracked Sponsors</h2>
                                        <button onClick={() => setShowAddSponsor(true)} className="text-indigo-600 hover:text-indigo-800">+ Add</button>
                                    </div>
                                    <div className="mb-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs">
                                        <strong>Note:</strong> Sponsor tracking is for reference only. To find bills by sponsor, use{' '}
                                        <a href="https://lims.dccouncil.gov/voteSearch" target="_blank" rel="noopener noreferrer" className="text-blue-600 underline">lims.dccouncil.gov/voteSearch</a>
                                        {' '}then check the bills here to track them.
                                    </div>
                                    <div className="space-y-2">
                                        {trackedSponsors.map(sponsor => (
                                            <div key={sponsor} className="flex items-center justify-between p-2 bg-purple-50 rounded">
                                                <span className="text-sm">{sponsor}</span>
                                                <button onClick={() => removeSponsor(sponsor)} className="text-red-600 hover:text-red-800">×</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-xl font-semibold mb-4">Filters</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Search</label>
                                            <input type="text" value={filters.keywords} onChange={e => setFilters({...filters, keywords: e.target.value})} placeholder="Search..." className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                        {[['Category','category',categories],['Committee','committee',committees],['Introduced By','introducedBy',introducers],['Assigned To','assignedTo',assignees],['Priority','priority',priorities]].map(([label, key, opts]) => (
                                            <div key={key}>
                                                <label className="block text-sm font-medium mb-2">{label}</label>
                                                <select value={filters[key]} onChange={e => setFilters({...filters, [key]: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                                    {opts.map(o => <option key={o} value={o}>{o}</option>)}
                                                </select>
                                            </div>
                                        ))}
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Action Status</label>
                                            <select value={filters.actionStatus} onChange={e => setFilters({...filters, actionStatus: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                                {actionStatuses.map(s => <option key={s} value={s}>{s === 'all' ? 'all' : getActionStatusLabel(s)}</option>)}
                                            </select>
                                        </div>
                                        <div className="pt-4 border-t">
                                            <label className="flex items-center cursor-pointer mb-3">
                                                <input type="checkbox" checked={filters.hideTrackedItems} onChange={e => setFilters({...filters, hideTrackedItems: e.target.checked})} className="mr-2" />
                                                <span className="text-sm font-medium">Hide all tracked items</span>
                                            </label>
                                            <p className="text-xs text-gray-500 ml-6 mb-3">Hide items marked as Action Needed, Monitor & Assess, or Action Completed</p>
                                            <label className="flex items-center cursor-pointer">
                                                <input type="checkbox" checked={filters.hasUpcomingHearing} onChange={e => setFilters({...filters, hasUpcomingHearing: e.target.checked})} className="mr-2" />
                                                <span className="text-sm font-medium">Show only items with upcoming hearings</span>
                                            </label>
                                            <p className="text-xs text-gray-500 mt-1 ml-6">Filter to bills/resolutions with scheduled hearings</p>
                                            {!hasHearingDataLoaded && filters.hasUpcomingHearing && (
                                                <p className="text-xs text-amber-600 mt-1 ml-6">💡 Click "Check Hearings" for precise dates from the API.</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Legislation ({filteredItems.length})</h2>
                                        <div className="flex items-center gap-2">
                                            <select
                                                value={activityFilter}
                                                onChange={e => setActivityFilter(e.target.value)}
                                                className={`px-3 py-1 text-xs rounded font-medium border ${activityFilter !== 'all' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600 border-gray-300'}`}
                                            >
                                                <option value="all">All Activity</option>
                                                <option value="7">Active last 7 days</option>
                                                <option value="30">Active last 30 days</option>
                                                <option value="90">Active last 90 days</option>
                                            </select>
                                            <button
                                                onClick={() => setSortByActivity(s => !s)}
                                                className={`px-3 py-1 text-xs rounded font-medium border ${sortByActivity ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}`}
                                            >
                                                {sortByActivity ? '🕐 Sorted by Latest Activity' : 'Sort by Latest Activity'}
                                            </button>
                                        </div>
                                    </div>
                                    {loading && <div className="text-center py-12 text-gray-500">Loading legislation...</div>}
                                    {!loading && filteredItems.length === 0 && (
                                        <div className="text-center py-12 text-gray-500">
                                            {items.length === 0 ? 'No tracked items yet. Click Refresh to search for legislation.' : 'No items match your filters'}
                                        </div>
                                    )}
                                    <div className="space-y-4">
                                        {filteredItems.map(item => {
                                            const hearing = hearingData[item.id];
                                            const hasUpcomingHearing = hearing && hearing.date && !hearing.isPast;
                                            const hasPastHearing = hearing && hearing.date && hearing.isPast;
                                            // Keyword-based hearing badge only for non-manual entries
                                            const hasKeywordHearing = !item.isManualEntry && !hasUpcomingHearing && !hasPastHearing && item.status && (
                                                item.status.toLowerCase().includes('hearing') ||
                                                item.status.toLowerCase().includes('scheduled') ||
                                                item.status.toLowerCase().includes('notice') ||
                                                item.status.toLowerCase().includes('markup')
                                            );
                                            const hasReReferral = item.committeeReReferral && item.committeeReReferral.length > 0;
                                            const latestActivityStr = item.latestActivityDate
                                                ? new Date(item.latestActivityDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                                                : null;
                                            return (
                                                <div key={item.id} className={`p-4 border-2 rounded-lg ${item.isNew ? 'border-red-200 bg-red-50' : 'border-gray-200'} ${selectedItems.has(item.id) ? 'ring-2 ring-indigo-400' : ''}`}>
                                                    <div className="flex items-start gap-3">
                                                        <input type="checkbox" checked={selectedItems.has(item.id)} onChange={() => toggleSelection(item.id)} className="mt-1" />
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                                                {item.isNew && <span className="px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded">NEW</span>}
                                                                {hasUpcomingHearing && (
                                                                    <span className="px-2 py-0.5 bg-amber-500 text-white text-xs font-bold rounded">📅 {hearing.dateStr}</span>
                                                                )}
                                                                {hasKeywordHearing && (
                                                                    <span className="px-2 py-0.5 bg-yellow-500 text-white text-xs font-bold rounded">📅 HEARING</span>
                                                                )}
                                                                {item.deadline && item.isManualEntry && (
                                                                    <span className="px-2 py-0.5 bg-purple-500 text-white text-xs font-bold rounded">⏰ {new Date(item.deadline + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                                                )}
                                                                {hasReReferral && (
                                                                    <span className="px-2 py-0.5 bg-orange-400 text-white text-xs font-bold rounded">🔁 Re-referred</span>
                                                                )}
                                                                {item.activityCount > 0 && (
                                                                    <span className="px-2 py-0.5 bg-gray-500 text-white text-xs font-bold rounded" title="Status updates since introduction">{item.activityCount} update{item.activityCount !== 1 ? 's' : ''}</span>
                                                                )}
                                                                {item.hasNewActivity && selectedItems.has(item.id) && (
                                                                    <span className="px-2 py-0.5 bg-orange-500 text-white text-xs font-bold rounded animate-pulse">🔔 NEW ACTIVITY</span>
                                                                )}
                                                                {selectedItems.has(item.id) && (
                                                                    <span className={`px-2 py-0.5 text-xs font-bold rounded ${getActionStatusColor(item.actionStatus)}`}>{getActionStatusLabel(item.actionStatus)}</span>
                                                                )}
                                                                {item.priority && (
                                                                    <span className={`px-2 py-0.5 text-xs font-bold rounded uppercase ${getPriorityColor(item.priority)}`}>{item.priority}</span>
                                                                )}
                                                                <h3 className="font-semibold">{item.title}</h3>
                                                            </div>

                                                            {hasUpcomingHearing && (
                                                                <div className="mb-2 p-2 bg-amber-50 border-l-4 border-amber-400 rounded flex items-start justify-between">
                                                                    <div>
                                                                        <div className="text-xs font-semibold text-amber-800 mb-0.5">📅 {hearing.type || 'Hearing'}</div>
                                                                        <div className="text-sm text-amber-900 font-medium">{hearing.dateStr}{hearing.timeStr && hearing.timeStr !== '12:00 AM' ? ` at ${hearing.timeStr}` : ''}</div>
                                                                        {hearing.location && <div className="text-xs text-amber-700 mt-0.5">📍 {hearing.location}</div>}
                                                                    </div>
                                                                    <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-xs text-amber-700 underline ml-2 whitespace-nowrap">LIMS →</a>
                                                                </div>
                                                            )}

                                                            {hasReReferral && (
                                                                <div className="mb-2 p-2 bg-orange-50 border-l-4 border-orange-400 rounded">
                                                                    <div className="text-xs font-semibold text-orange-800 mb-1">🔁 Committee Re-Referral</div>
                                                                    {item.committeeReReferral.map((ref, idx) => (
                                                                        <div key={idx} className="text-xs text-orange-700">
                                                                            {ref.reReferralDate && <span className="font-medium">{new Date(ref.reReferralDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} — </span>}
                                                                            {Array.isArray(ref.committeeName) ? ref.committeeName.join(', ') : (ref.committeeName || ref.fromCommittee && ref.toCommittee ? `${ref.fromCommittee} → ${ref.toCommittee}` : '')}
                                                                            {ref.reReferralPublishedDate && <span className="text-orange-500 ml-1">(published {new Date(ref.reReferralPublishedDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})</span>}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            )}

                                                            {item.hasNewActivity && item.activitySummary && selectedItems.has(item.id) && (
                                                                <div className="mb-2 p-2 bg-orange-50 border-l-4 border-orange-500 rounded">
                                                                    <div className="flex justify-between items-start">
                                                                        <div>
                                                                            <div className="text-xs font-semibold text-orange-800 mb-1">Activity Update:</div>
                                                                            <p className="text-sm text-orange-700">{item.activitySummary}</p>
                                                                        </div>
                                                                        <button onClick={() => markActivityAsSeen(item.id)} className="text-xs text-orange-600 hover:text-orange-800 underline ml-2">Dismiss</button>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className="text-xs text-gray-500 mb-2">
                                                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">{item.billNumber || item.id}</a>
                                                                {item.introducedBy && <span className="ml-2">• Introduced by: {item.introducedBy}</span>}
                                                                {latestActivityStr && (
                                                                    <span className="ml-2">• {item.latestActivityLabel ? `${item.latestActivityLabel}: ${latestActivityStr}` : `Latest activity: ${latestActivityStr}`}</span>
                                                                )}
                                                                {hearing?.checkedAt && <span className="ml-2 text-gray-400">• Checked {new Date(hearing.checkedAt).toLocaleDateString()}</span>}
                                                            </div>
                                                            <p className="text-sm text-gray-600 mb-2">{item.description}</p>

                                                            {(item.activityTimeline || []).length > 0 && (
                                                                <div className="mb-2">
                                                                    <button
                                                                        onClick={() => setExpandedHistory(prev => {
                                                                            const next = new Set(prev);
                                                                            next.has(item.id) ? next.delete(item.id) : next.add(item.id);
                                                                            return next;
                                                                        })}
                                                                        className="text-xs text-gray-400 hover:text-gray-600 font-medium"
                                                                    >
                                                                        {expandedHistory.has(item.id) ? '▲ Hide activity timeline' : `▼ Activity timeline (${(item.activityTimeline || []).length} events)`}
                                                                    </button>
                                                                    {expandedHistory.has(item.id) && (
                                                                        <div className="mt-1 p-2 bg-gray-50 border border-gray-200 rounded">
                                                                            {(item.activityTimeline || []).map((e, idx) => (
                                                                                <div key={idx} className={`flex items-start gap-2 text-xs py-1 border-b border-gray-100 last:border-0 ${e.isFuture ? 'opacity-60' : ''}`}>
                                                                                    <span className="text-gray-400 whitespace-nowrap w-28 shrink-0">{e.dateStr}</span>
                                                                                    <span className={`font-medium ${e.isFuture ? 'text-amber-600' : 'text-gray-700'}`}>
                                                                                        {e.isFuture ? '📅 ' : ''}{e.label}
                                                                                    </span>
                                                                                    {e.extra && <span className="text-gray-400 italic">· {e.extra}</span>}
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}

                                                            {(item.additionalInformation || item.manualSummary) && (
                                                                <div className="mb-2">
                                                                    <div className="flex items-center gap-2">
                                                                        <button
                                                                            onClick={() => setExpandedInfo(prev => {
                                                                                const next = new Set(prev);
                                                                                next.has(item.id) ? next.delete(item.id) : next.add(item.id);
                                                                                return next;
                                                                            })}
                                                                            className="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                                                                        >
                                                                            {expandedInfo.has(item.id) ? '▲ Hide bill summary' : '▼ Show bill summary'}
                                                                        </button>
                                                                        {item.manualSummary && <span className="text-xs text-purple-500">(manual)</span>}
                                                                        {selectedItems.has(item.id) && (
                                                                            <button onClick={() => { setEditingSummary(item.id); setSummaryText(item.manualSummary || ''); }} className="text-xs text-gray-400 hover:text-gray-600 underline">edit</button>
                                                                        )}
                                                                    </div>
                                                                    {expandedInfo.has(item.id) && (
                                                                        <div className="mt-1 p-2 bg-gray-50 border border-gray-200 rounded text-xs text-gray-700 leading-relaxed">
                                                                            {item.manualSummary || item.additionalInformation}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                            {!item.additionalInformation && !item.manualSummary && selectedItems.has(item.id) && (
                                                                <div className="mb-2">
                                                                    <button onClick={() => { setEditingSummary(item.id); setSummaryText(''); }} className="text-xs text-gray-400 hover:text-gray-600 underline">+ Add bill summary</button>
                                                                </div>
                                                            )}

                                                            {item.committees && item.committees.length > 0 && (
                                                                <div className="mb-2">
                                                                    <div className="text-xs font-semibold mb-1">Committees:</div>
                                                                    <div className="flex flex-wrap gap-1">
                                                                        {item.committees.map((com, idx) => (
                                                                            <span key={`${item.id}-${idx}`} className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded">{com}</span>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {item.isManualEntry && (item.noticeId || item.registerIssue || item.registerNotes || item.deadline) && (
                                                                <div className="mb-2 p-2 bg-purple-50 border border-purple-200 rounded">
                                                                    {item.deadline && <div className="text-xs mb-1"><span className="font-semibold">⏰ Deadline/Hearing:</span> {new Date(item.deadline + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</div>}
                                                                    {item.noticeId && <div className="text-xs mb-1"><span className="font-semibold">Notice ID:</span> {item.noticeId}</div>}
                                                                    {item.registerIssue && <div className="text-xs mb-1"><span className="font-semibold">Register Issue:</span> {item.registerIssue}</div>}
                                                                    {item.registerNotes && <div className="text-xs"><span className="font-semibold">Register Notes:</span><p className="mt-1 whitespace-pre-wrap">{item.registerNotes}</p></div>}
                                                                </div>
                                                            )}

                                                            {selectedItems.has(item.id) && (
                                                                <div className="grid grid-cols-3 gap-2 mb-2">
                                                                    <div>
                                                                        <label className="block text-xs font-semibold mb-1">Assigned To:</label>
                                                                        <select value={item.assignedTo || 'Unassigned'} onChange={e => updateAssignment(item.id, e.target.value)} className="w-full px-2 py-1 text-xs border rounded">
                                                                            {teamMembers.map(member => <option key={member.id} value={member.name}>{member.name}</option>)}
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs font-semibold mb-1">Priority:</label>
                                                                        <select value={item.priority || 'medium'} onChange={e => updatePriority(item.id, e.target.value)} className="w-full px-2 py-1 text-xs border rounded">
                                                                            <option value="high">High</option>
                                                                            <option value="medium">Medium</option>
                                                                            <option value="low">Low</option>
                                                                        </select>
                                                                    </div>
                                                                    <div>
                                                                        <label className="block text-xs font-semibold mb-1">Action Status:</label>
                                                                        <select value={item.actionStatus || 'action_needed'} onChange={e => updateActionStatus(item.id, e.target.value)} className="w-full px-2 py-1 text-xs border rounded">
                                                                            <option value="action_needed">Action Needed</option>
                                                                            <option value="action_completed">Action Completed</option>
                                                                            <option value="monitor_and_assess">Monitor & Assess</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            {itemNotes[item.id] && (
                                                                <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                                                    <div className="flex justify-between">
                                                                        <div>
                                                                            <div className="text-xs font-semibold text-yellow-800 mb-1">Note:</div>
                                                                            <p className="text-sm">{itemNotes[item.id]}</p>
                                                                        </div>
                                                                        <button onClick={() => deleteNote(item.id)} className="text-red-600 hover:text-red-800">×</button>
                                                                    </div>
                                                                </div>
                                                            )}

                                                            <div className="flex items-center justify-between mt-2">
                                                                <div className="flex items-center gap-2 text-xs text-gray-500 flex-wrap">
                                                                    <span className="px-2 py-1 bg-indigo-100 text-indigo-700 rounded">{item.category}</span>
                                                                    <span className="px-2 py-1 bg-gray-100 text-gray-700 rounded">{item.status}</span>
                                                                    <span>Introduced: {item.date}</span>
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    {selectedItems.has(item.id) && !item.isManualEntry && (
                                                                        <button onClick={() => checkHearingForItem(item.id)} className="text-xs text-amber-600 hover:text-amber-800 border border-amber-300 rounded px-2 py-0.5">📅 Check</button>
                                                                    )}
                                                                    {item.isManualEntry && (
                                                                        <>
                                                                            <button onClick={() => editManualEntry(item)} className="text-sm text-blue-600 hover:text-blue-800">Edit</button>
                                                                            <button onClick={() => deleteManualEntry(item.id)} className="text-sm text-red-600 hover:text-red-800">Delete</button>
                                                                        </>
                                                                    )}
                                                                    <button onClick={() => { setEditingNote(item.id); setNoteText(itemNotes[item.id] || ''); }} className="text-sm text-indigo-600 hover:text-indigo-800">
                                                                        {itemNotes[item.id] ? 'Edit Note' : 'Add Note'}
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {!loading && currentSearchCategory && hasMoreResults && filteredItems.length > 0 && (
                                        <div className="mt-6 text-center">
                                            <button onClick={loadMoreResults} className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Load More Results</button>
                                            <p className="text-xs text-gray-500 mt-2">Showing {filteredItems.length} results. Click to load 100 more.</p>
                                        </div>
                                    )}
                                    {!loading && currentSearchCategory && !hasMoreResults && filteredItems.length > 0 && (
                                        <div className="mt-6 text-center text-sm text-gray-500">All results loaded ({filteredItems.length} total)</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* HEARING PANEL */}
                    {showHearingPanel && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <h3 className="text-2xl font-bold text-gray-900">📅 Hearing Report</h3>
                                        <p className="text-sm text-gray-500">Updated automatically each weekday morning by the cron job</p>
                                    </div>
                                    <button onClick={() => setShowHearingPanel(false)} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                                </div>
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className="p-4 rounded-lg text-center bg-gray-100 text-gray-800">
                                        <div className="text-3xl font-bold">{Object.keys(hearingData).length}</div>
                                        <div className="text-sm font-medium">Items Checked</div>
                                    </div>
                                    <div className="p-4 rounded-lg text-center bg-amber-100 text-amber-800">
                                        <div className="text-3xl font-bold">{Object.values(hearingData).filter(h => h.date && !h.isPast).length}</div>
                                        <div className="text-sm font-medium">Upcoming Hearings</div>
                                    </div>
                                    <div className="p-4 rounded-lg text-center bg-blue-100 text-blue-800">
                                        <div className="text-3xl font-bold">{Object.values(hearingData).filter(h => !h.date).length}</div>
                                        <div className="text-sm font-medium">No Hearing Scheduled</div>
                                    </div>
                                </div>

                                {itemsWithUpcomingHearings.length > 0 ? (
                                    <div className="mb-6">
                                        <h4 className="text-lg font-semibold text-amber-800 mb-3">Upcoming Hearings</h4>
                                        <div className="space-y-3">
                                            {itemsWithUpcomingHearings.map(({ item, hearing }) => (
                                                <div key={item.id} className="p-4 border-2 border-amber-200 bg-amber-50 rounded-lg">
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="font-semibold text-gray-900 mb-1">{item.title}</div>
                                                            <div className="flex items-center gap-3 flex-wrap">
                                                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-sm text-indigo-600 hover:underline">{item.billNumber || item.id}</a>
                                                                <span className="text-sm text-gray-600">{item.category}</span>
                                                                {item.assignedTo && item.assignedTo !== 'Unassigned' && <span className="text-sm text-gray-600">👤 {item.assignedTo}</span>}
                                                            </div>
                                                        </div>
                                                        <div className="text-right ml-4">
                                                            <div className="font-bold text-amber-700 text-sm">{hearing.dateStr}</div>
                                                            {hearing.timeStr && hearing.timeStr !== '12:00 AM' && <div className="text-xs text-amber-600">{hearing.timeStr}</div>}
                                                            {hearing.type && <div className="text-xs text-amber-600 italic">{hearing.type}</div>}
                                                            {hearing.location && <div className="text-xs text-gray-500 mt-1">📍 {hearing.location}</div>}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-gray-500">No upcoming hearings found for your tracked bills.</div>
                                )}

                                {Object.entries(hearingData).filter(([, h]) => h.error).length > 0 && (
                                    <details className="mt-4">
                                        <summary className="cursor-pointer text-sm font-medium text-red-600 hover:text-red-800 py-2">
                                            ⚠️ Fetch errors ({Object.entries(hearingData).filter(([, h]) => h.error).length} items)
                                        </summary>
                                        <div className="mt-2 space-y-2">
                                            {Object.entries(hearingData).filter(([, h]) => h.error).map(([id, h]) => (
                                                <div key={id} className="p-2 bg-red-50 rounded border border-red-200 text-xs text-red-700"><strong>{id}:</strong> {h.error}</div>
                                            ))}
                                        </div>
                                    </details>
                                )}

                                <div className="mt-6 flex gap-3">
                                    <button onClick={checkHearingsForTrackedItems} disabled={checkingHearings} className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:bg-gray-400 font-medium">
                                        {checkingHearings ? 'Checking…' : '🔄 Re-check All'}
                                    </button>
                                    <button onClick={() => setShowHearingPanel(false)} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddKeyword && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Keyword</h3>
                                <input type="text" value={newKeyword} onChange={e => setNewKeyword(e.target.value)} onKeyPress={e => e.key === 'Enter' && addKeyword()} placeholder="e.g., housing, eviction, affordable (comma-separate to add multiple)" className="w-full px-3 py-2 border rounded-lg mb-4" autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={addKeyword} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add</button>
                                    <button onClick={() => { setShowAddKeyword(false); setNewKeyword(''); }} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddCommittee && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Committee</h3>
                                <p className="text-sm text-gray-600 mb-3">Enter the committee name. Try partial names like "Housing" or "Transportation"</p>
                                <input type="text" value={newCommittee} onChange={e => setNewCommittee(e.target.value)} onKeyPress={e => e.key === 'Enter' && addCommittee()} placeholder="e.g., Housing, Transportation, Judiciary" className="w-full px-3 py-2 border rounded-lg mb-4" autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={addCommittee} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add</button>
                                    <button onClick={() => { setShowAddCommittee(false); setNewCommittee(''); }} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddSponsor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Sponsor</h3>
                                <p className="text-sm text-gray-600 mb-3">Enter the councilmember's last name or full name</p>
                                <input type="text" value={newSponsor} onChange={e => setNewSponsor(e.target.value)} onKeyPress={e => e.key === 'Enter' && addSponsor()} placeholder="e.g., Allen, Nadeau, McDuffie" className="w-full px-3 py-2 border rounded-lg mb-4" autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={addSponsor} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Add</button>
                                    <button onClick={() => { setShowAddSponsor(false); setNewSponsor(''); }} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingNote && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                <h3 className="text-xl font-semibold mb-4">Add Note</h3>
                                <textarea value={noteText} onChange={e => setNoteText(e.target.value)} placeholder="Enter your notes..." className="w-full px-3 py-2 border rounded-lg mb-4 h-32" autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={saveNote} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                                    <button onClick={() => { setEditingNote(null); setNoteText(''); }} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingSummary && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                                <h3 className="text-xl font-semibold mb-1">Bill Summary</h3>
                                <p className="text-xs text-gray-500 mb-4">This overrides the LIMS summary for display and emails. Useful when LIMS hasn't populated the field yet.</p>
                                <textarea value={summaryText} onChange={e => setSummaryText(e.target.value)} placeholder="Paste or type the bill summary..." className="w-full px-3 py-2 border rounded-lg mb-4 h-40" autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={saveSummary} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                                    {items.find(i => i.id === editingSummary)?.manualSummary && (
                                        <button onClick={() => { deleteManualSummary(editingSummary); setEditingSummary(null); setSummaryText(''); }} className="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">Remove</button>
                                    )}
                                    <button onClick={() => { setEditingSummary(null); setSummaryText(''); }} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showManualEntry && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
                                <h3 className="text-xl font-semibold mb-4">{editingManualEntry ? 'Edit DC Register Item' : 'Add DC Register Item'}</h3>
                                <p className="text-sm text-gray-600 mb-4">Visit <a href="https://www.dcregs.dc.gov/" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline">dcregs.dc.gov</a> to find recent regulations</p>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Title *</label>
                                        <input type="text" value={manualEntry.title} onChange={e => setManualEntry({...manualEntry, title: e.target.value})} placeholder="e.g., Department of Health - Notice of Final Rulemaking..." className="w-full px-3 py-2 border rounded-lg" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Notice ID</label>
                                            <input type="text" value={manualEntry.noticeId} onChange={e => setManualEntry({...manualEntry, noticeId: e.target.value})} placeholder="e.g., 2024-123" className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Register Issue</label>
                                            <input type="text" value={manualEntry.registerIssue} onChange={e => setManualEntry({...manualEntry, registerIssue: e.target.value})} placeholder="e.g., Vol. 71, No. 23" className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Agency</label>
                                        <input type="text" value={manualEntry.agency} onChange={e => setManualEntry({...manualEntry, agency: e.target.value})} placeholder="e.g., Department of Health" className="w-full px-3 py-2 border rounded-lg" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Status</label>
                                            <select value={manualEntry.status} onChange={e => setManualEntry({...manualEntry, status: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                                {['Notice','Published','Proposed','Final Rulemaking','Emergency','Comment Period'].map(s => <option key={s}>{s}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Date</label>
                                            <input type="date" value={manualEntry.date} onChange={e => setManualEntry({...manualEntry, date: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">⏰ Deadline / Hearing Date (optional)</label>
                                        <input type="date" value={manualEntry.deadline} onChange={e => setManualEntry({...manualEntry, deadline: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
                                        <p className="text-xs text-gray-500 mt-1">Shows as a purple deadline badge on the card</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Register Notes</label>
                                        <textarea value={manualEntry.registerNotes} onChange={e => setManualEntry({...manualEntry, registerNotes: e.target.value})} placeholder="Paste text from the DC Register notice..." className="w-full px-3 py-2 border rounded-lg h-32" />
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Assigned To</label>
                                            <select value={manualEntry.assignedTo} onChange={e => setManualEntry({...manualEntry, assignedTo: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                                {teamMembers.map(member => <option key={member.id} value={member.name}>{member.name}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Priority</label>
                                            <select value={manualEntry.priority} onChange={e => setManualEntry({...manualEntry, priority: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                                <option value="high">High</option>
                                                <option value="medium">Medium</option>
                                                <option value="low">Low</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Action Status</label>
                                            <select value={manualEntry.actionStatus} onChange={e => setManualEntry({...manualEntry, actionStatus: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                                                <option value="action_needed">Action Needed</option>
                                                <option value="action_completed">Action Completed</option>
                                                <option value="monitor_and_assess">Monitor & Assess</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Link (optional)</label>
                                        <input type="url" value={manualEntry.link} onChange={e => setManualEntry({...manualEntry, link: e.target.value})} placeholder="https://www.dcregs.dc.gov/..." className="w-full px-3 py-2 border rounded-lg" />
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={editingManualEntry ? updateManualEntry : addManualEntry} className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">{editingManualEntry ? 'Update Item' : 'Add Item'}</button>
                                    <button onClick={() => { setShowManualEntry(false); setEditingManualEntry(null); setManualEntry({ title: '', agency: '', status: 'Published', date: new Date().toISOString().split('T')[0], link: '', assignedTo: 'Unassigned', priority: 'medium', actionStatus: 'action_needed', noticeId: '', registerIssue: '', registerNotes: '' }); }} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showActivityLog && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Activity Log</h3>
                                    <button onClick={() => setShowActivityLog(false)} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                                </div>
                                <div className="space-y-2">
                                    {activityLog.map(log => (
                                        <div key={log.id} className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <span className="font-semibold text-sm">{log.action.replace(/_/g, ' ').toUpperCase()}</span>
                                                    {log.item_title && <span className="text-sm text-gray-600 ml-2">- {log.item_title}</span>}
                                                    {log.details && Object.keys(log.details).length > 0 && <div className="text-xs text-gray-500 mt-1">{JSON.stringify(log.details)}</div>}
                                                </div>
                                                <span className="text-xs text-gray-400">{new Date(log.created_at).toLocaleString()}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {activityLog.length === 0 && <div className="text-center py-8 text-gray-500">No activity recorded yet</div>}
                                </div>
                            </div>
                        </div>
                    )}

                    {showEmailPreview && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Email Preview</h3>
                                    <button onClick={() => setShowEmailPreview(false)} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                                </div>
                                <pre className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm whitespace-pre-wrap font-mono mb-4">{generateEmailBody()}</pre>
                                <div className="flex gap-2">
                                    <button onClick={copyEmailToClipboard} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Copy to Clipboard</button>
                                    <button onClick={() => setShowEmailPreview(false)} className="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTeamManagement && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-semibold">Manage Team Members</h3>
                                    <button onClick={() => { setShowTeamManagement(false); setEditingTeamMember(null); setTeamMemberForm({ name: '', email: '' }); }} className="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                                </div>
                                <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h4 className="font-semibold mb-3">{editingTeamMember ? 'Edit Team Member' : 'Add New Team Member'}</h4>
                                    <div className="grid grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Name *</label>
                                            <input type="text" value={teamMemberForm.name} onChange={e => setTeamMemberForm({...teamMemberForm, name: e.target.value})} placeholder="e.g., John Doe" className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Email (optional)</label>
                                            <input type="email" value={teamMemberForm.email} onChange={e => setTeamMemberForm({...teamMemberForm, email: e.target.value})} placeholder="john@example.com" className="w-full px-3 py-2 border rounded-lg" />
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={editingTeamMember ? updateTeamMember : addTeamMember} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">{editingTeamMember ? 'Update' : 'Add Team Member'}</button>
                                        {editingTeamMember && <button onClick={() => { setEditingTeamMember(null); setTeamMemberForm({ name: '', email: '' }); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>}
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <h4 className="font-semibold mb-2">Current Team Members</h4>
                                    {teamMembers.map(member => (
                                        <div key={member.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div>
                                                <div className="font-medium">{member.name}</div>
                                                {member.email && <div className="text-sm text-gray-600">{member.email}</div>}
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => editTeamMember(member)} className="px-3 py-1 text-sm text-blue-600 hover:text-blue-800">Edit</button>
                                                {member.name !== 'Unassigned' && <button onClick={() => deleteTeamMember(member.id)} className="px-3 py-1 text-sm text-red-600 hover:text-red-800">Delete</button>}
                                            </div>
                                        </div>
                                    ))}
                                    {teamMembers.length === 0 && <div className="text-center py-8 text-gray-500">No team members yet. Add one above!</div>}
                                </div>
                                <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
                                    <strong>Note:</strong> Editing a team member's name will update all items assigned to them. Deleting removes them from the dropdown but preserves existing assignments.
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<DCPolicyTracker />, document.getElementById('root'));
    </script>
</body>
</html>
